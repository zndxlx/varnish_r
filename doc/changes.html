<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7614 2013-02-21 15:55:51Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<div class="section" id="varnish-cache-5-1-2-2017-04-07">
<h1>Varnish Cache 5.1.2 (2017-04-07)</h1>
<ul class="simple">
<li>Fix an endless loop in Backend Polling (#2295)</li>
<li>Fix a Chunked bug in tight workspaces (#2207, #2275)</li>
<li>Fix a bug relating to req.body when on waitinglist (#2266)</li>
<li>Handle EPIPE on broken TCP connections (#2267)</li>
<li>Work around the x86 arch's turbo-double FP format in parameter
setup code. (#1875)</li>
<li>Fix race related to backend probe with proxy header (#2278)</li>
<li>Keep VCL temperature consistent between mgt/worker also when
worker protests.</li>
<li>A lot of HTTP/2 fixes.</li>
</ul>
</div>
<div class="section" id="varnish-cache-5-1-1-2017-03-16">
<h1>Varnish Cache 5.1.1 (2017-03-16)</h1>
<ul class="simple">
<li>Fix bug introduced by stubborn old bugger right before release
5.1.0 was cut.</li>
</ul>
</div>
<div class="section" id="varnish-cache-5-1-0-2017-03-15">
<h1>Varnish Cache 5.1.0 (2017-03-15)</h1>
<ul class="simple">
<li>Added varnishd command-line options -I, -x and -?, and tightened
restrictions on permitted combinations of options.</li>
<li>More progress on support for HTTP/2.</li>
<li>Add <tt class="docutils literal">return(fail)</tt> to almost all VCL subroutines.</li>
<li>Restored the old hit-for-pass, invoked with
<tt class="docutils literal">return(pass(DURATION))</tt> from
<tt class="docutils literal">vcl_backend_response</tt>. hit-for-miss remains the default.  Added
the cache_hitmiss stat, and cache_hitpass only counts the new/old
hit-for-pass cases. Restored HitPass to the Varnish log, and added
HitMiss. Added the HFP prefix to TTL log entries to log a
hit-for-pass duration.</li>
<li>Rolled back the fix for #1206. Client delivery decides solely whether
to send a 304 client response, based on client request and response
headers.</li>
<li>Added vtest.sh.</li>
<li>Added vxid as a lefthand side for VSL queries.</li>
<li>Added the setenv and write_body commands for Varnish test cases (VTCs).
err_shell is deprecated. Also added the operators -cliexpect, -match and
-hdrlen, and -reason replaces -msg. Added the ${bad_backend} macro.</li>
<li>varnishtest can be stopped with the TERM, INT and KILL signals, but
not with HUP.</li>
<li>The fallback director has now an extra, optional parameter to keep
using the current backend until it falls sick.</li>
<li>VMOD shared libraries are now copied to the workdir, to avoid problems
when VMODs are updated via packaging systems.</li>
<li>Bump the VRT version to 6.0.</li>
<li>Export more symbols from libvarnishapi.so.</li>
<li>The size of the VSL log is limited to 4G-1b, placing upper bounds on
the -l option and the vsl_space and vsm_space parameters.</li>
<li>Added parameters clock_step, thread_pool_reserve and ban_cutoff.</li>
<li>Parameters vcl_dir and vmod_dir are deprecated, use vcl_path and
vmod_path instead.</li>
<li>All parameters are defined, even on platforms that don't support
them.  An unsupported parameter is documented as such in
param.show. Setting such a parameter is not an error, but has no
effect.</li>
<li>Clarified the interpretations of the + and - operators in VCL with
operands of the various data types.</li>
<li>DURATION types may be used in boolean contexts.</li>
<li>INT, DURATION and REAL values can now be negative.</li>
<li>Response codes 1000 or greater may now be set in VCL internally.
resp.status is delivered modulo 1000 in client responses.</li>
<li>IP addresses can be compared for equality in VCL.</li>
<li>Introduce the STEVEDORE data type, and the objects storage.SNAME
in VCL.  Added req.storage and beresp.storage; beresp.storage_hint
is deprecated.</li>
<li>Retired the umem stevedore.</li>
<li>req.ttl is deprecated.</li>
<li>Added std.getenv() and std.late_100_continue().</li>
<li>The fetch_failed stat is incremented for any kind of fetch failure.</li>
<li>Added the stats n_test_gunzip and bans_lurker_obj_killed_cutoff.</li>
<li>Clarified the meanings of the %r, %{X}i and %{X}o formatters in
varnishncsa.</li>
</ul>
<div class="section" id="bugs-fixed">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2251">2251</a> - varnishapi.pc and varnishconfdir</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2250">2250</a> - vrt.h now depends on vdef.h making current vmod fail.</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2249">2249</a> - &quot;logexpect -wait&quot; doesn't fail</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2245">2245</a> - Varnish doesn't start, if use vmod (vmod_cache dir was permission denied)</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2241">2241</a> - VSL fails to get hold of SHM</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2233">2233</a> - Crash on &quot;Assert error in WS_Assert(), cache/cache_ws.c line 59&quot;</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2227">2227</a> - -C flag broken in HEAD</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2217">2217</a> - fix argument processing -C regression</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2207">2207</a> - Assert error in V1L_Write()</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2205">2205</a> - Strange bug when I set client.ip with another string</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2203">2203</a> - unhandled SIGPIPE</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2200">2200</a> - Assert error in vev_compact_pfd(), vev.c line 394</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2197">2197</a> - ESI parser panic on malformed src URL</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2190">2190</a> - varnishncsa: The %r formatter is NOT equivalent to &quot;%m <a class="reference external" href="http:/">http:/</a>/%{Host}i%U%q %H&quot;</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2186">2186</a> - Assert error in sml_iterator(), storage/storage_simple.c line 263</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2184">2184</a> - Cannot subtract a negative number</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2177">2177</a> - Clarify interactions between restarts and labels</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2175">2175</a> - Backend leak between a top VCL and a label</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2174">2174</a> - Cflags overhaul</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2167">2167</a> - VCC will not parse a literal negative number where INT is expected</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2155">2155</a> - vmodtool removes text following $Event from RST docs</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2151">2151</a> - Health probes do not honor a backend's PROXY protocol setting</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2142">2142</a> - ip comparison fails</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2148">2148</a> - varnishncsa cannot decode Authorization header if the format is incorrect.</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2143">2143</a> - Assert error in exp_inbox(), cache/cache_expire.c line 195</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2134">2134</a> - Disable Nagle's</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2129">2129</a> - stack overflow with &gt;4 level esi</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2128">2128</a> - SIGSEGV NULL Pointer in STV__iter()</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2118">2118</a> - &quot;varnishstat -f MAIN.sess_conn -1&quot; produces empty output</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2117">2117</a> - SES_Close() EBADF / Wait_Enter() wp-&gt;fd &lt;= 0</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2115">2115</a> - VSM temporary files are not always deleted</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2110">2110</a> - [CLI] vcl.inline failures</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2104">2104</a> - Assert error in VFP_Open(), cache/cache_fetch_proc.c line 139: Condition((vc-&gt;wrk-&gt;vsl) != 0) not true</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2099">2099</a> - VCC BACKEND/HDR comparison produces duplicate gethdr_s definition</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2096">2096</a> - H2 t2002 fail on arm64/arm32</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2094">2094</a> - H2 t2000 fail on arm64/arm32</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2078">2078</a> - VCL comparison doesn't fold STRING_LIST</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2052">2052</a> - d12.vtc flaky when compiling with suncc</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2042">2042</a> - Send a 304 response for a just-gone-stale hitpass object when appropriate</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2041">2041</a> - Parent process should exit if it fails to start child</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2035">2035</a> - varnishd stalls with two consecutive Range requests using HTTP persistent connections</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2026">2026</a> - Add restart of poll in read_tmo</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2021">2021</a> - vcc &quot;used before defined&quot; check</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2017">2017</a> - &quot;%r&quot; field is wrong</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2016">2016</a> - confusing vcc error when acl referenced before definition</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2014">2014</a> - req.ttl: retire or document+vtc</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2010">2010</a> - varnishadm CLI behaving weirdly</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1991">1991</a> - Starting varnish on Linux with boot param ipv6.disable=1 fails</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1988">1988</a> - Lost req.url gives misleading error</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1914">1914</a> - set a custom storage for cache_req_body</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1899">1899</a> - varnishadm vcl.inline is overly obscure</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1874">1874</a> - clock-step related crash</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1865">1865</a> - Panic accessing beresp.backend.ip in vcl_backend_error{}</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1856">1856</a> - LostHeader setting req.url to an empty string</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1834">1834</a> - WS_Assert(), cache/cache_ws.c line 59</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1830">1830</a> - VSL API: &quot;duplicate link&quot; errors in request grouping when vsl_buffer is increased</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1764">1764</a> - nuke_limit is not honored</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1750">1750</a> - Fail more gracefully on -l &gt;= 4GB</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1704">1704</a> - fetch_failed not incremented</li>
</ul>
</div>
</div>
<div class="section" id="varnish-cache-5-0-0-2016-09-15">
<h1>Varnish Cache 5.0.0 (2016-09-15)</h1>
<ul class="simple">
<li>Documentation updates, especially the what's new and upgrade sections.</li>
<li>Via: header made by Varnish now says 5.0.</li>
<li>VMOD VRT ABI level increased.</li>
<li>[vcl] obj.(ttl|age|grace|keep) is now readable in vcl_deliver.</li>
<li>Latest devicedetect.vcl imported from upstream.</li>
<li>New system wide VCL directory: <tt class="docutils literal">/usr/share/varnish/vcl/</tt></li>
<li>std.integer() can now convert from REAL.</li>
</ul>
<div class="section" id="id60">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2086">2086</a> - Ignore H2 upgrades if the feature is not enabled.</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2054">2054</a> - Introduce new macros for out-of-tree VMODs</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2022">2022</a> - varnishstat -1 -f field inclusion glob doesn't allow VBE backend fields</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2008">2008</a> - Panic: Assert error in VBE_Delete()</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1800">1800</a> - PRIV_TASK in vcl_init/fini</li>
</ul>
</div>
</div>
<div class="section" id="varnish-cache-5-0-0-beta1-2016-09-09">
<h1>Varnish Cache 5.0.0-beta1 (2016-09-09)</h1>
<p>This is the first beta release of the upcoming 5.0 release.</p>
<p>The list of changes are numerous and will not be expanded on in detail.</p>
<p>The release notes contain more background information and are highly
recommended reading before using any of the new features.</p>
<p>Major items:</p>
<ul class="simple">
<li>VCL labels, allowing for per-vhost (or per-anything) separate VCL files.</li>
<li>(Very!) experimental support for HTTP/2.</li>
<li>Always send the request body to the backend, making possible to cache
responses of POST, PATCH requests etc with appropriate custom VCL and/or
VMODs.</li>
<li>hit-for-pass is now actually hit-for-miss.</li>
<li>new shard director for loadbalancing by consistent hashing</li>
<li>ban lurker performance improvements</li>
<li>access to obj.ttl, obj.age, obj.grace and obj.keep in vcl_deliver</li>
</ul>
<div class="section" id="news-for-vmod-authors">
<h2>News for Vmod Authors</h2>
<ul class="simple">
<li>workspace and PRIV_TASK for vcl cli events (init/fini methods)</li>
<li>PRIV_* now also work for object methods with unchanged scope.</li>
</ul>
</div>
</div>
<div class="section" id="varnish-cache-4-1-5-2017-02-09">
<h1>Varnish Cache 4.1.5 (2017-02-09)</h1>
<ul class="simple">
<li>No code changes since 4.1.5-beta2.</li>
</ul>
</div>
<div class="section" id="varnish-cache-4-1-5-beta2-2017-02-08">
<h1>Varnish Cache 4.1.5-beta2 (2017-02-08)</h1>
<ul class="simple">
<li>Update devicedetect.vcl</li>
</ul>
<div class="section" id="id66">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1704">1704</a> - Reverted the docfix and made the fech_failed counter do
what the documentation says it should do</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1865">1865</a> - Panic accessing beresp.backend.ip in vcl_backend_error</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2167">2167</a> - VCC will not parse a literal negative number where INT is
expected</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2184">2184</a> - Cannot subtract a negative number</li>
</ul>
</div>
</div>
<div class="section" id="varnish-cache-4-1-5-beta1-2017-02-02">
<h1>Varnish Cache 4.1.5-beta1 (2017-02-02)</h1>
<div class="section" id="id71">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1704">1704</a> - (docfix) Clarify description of fetch_failed counter</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1834">1834</a> - Panic in workspace exhaustion conditions</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2106">2106</a> - 4.1.3: Varnish crashes with &quot;Assert error in CNT_Request(),
cache/cache_req_fsm.c line 820&quot;</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2134">2134</a> - Disable Nagle's</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2148">2148</a> - varnishncsa cannot decode Authorization header if the
format is incorrect.</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2168">2168</a> - Compare 'bereq.backend' / 'req.backend_hint'
myDirector.backend() does not work</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2178">2178</a> - 4.1 branch does not compile on FreeBSD</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/pull/2188">2188</a> - Fix vsm_free (never incremented)</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2190">2190</a> - (docfix)varnishncsa: The %r formatter is NOT equivalent to...</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2197">2197</a> - ESI parser panic on malformed src URL</li>
</ul>
</div>
</div>
<div class="section" id="varnish-cache-4-1-4-2016-12-01">
<h1>Varnish Cache 4.1.4 (2016-12-01)</h1>
<div class="section" id="id82">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2035">2035</a> - varnishd stalls with two consecutive Range requests using
HTTP persistent connections</li>
</ul>
</div>
</div>
<div class="section" id="varnish-cache-4-1-4-beta3-2016-11-24">
<h1>Varnish Cache 4.1.4-beta3 (2016-11-24)</h1>
<ul class="simple">
<li>Include the current time of the panic in the panic output</li>
<li>Keep a reserve of idle threads for vital tasks</li>
</ul>
<div class="section" id="id84">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1874">1874</a> - clock-step related crash</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1889">1889</a> - (docfix) What does -p flag for backend.list command means</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2115">2115</a> - VSM temporary files are not always deleted</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2129">2129</a> - (docfix) stack overflow with &gt;4 level esi</li>
</ul>
</div>
</div>
<div class="section" id="varnish-cache-4-1-4-beta2-2016-10-13">
<h1>Varnish Cache 4.1.4-beta2 (2016-10-13)</h1>
<div class="section" id="id89">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1830">1830</a> - VSL API: &quot;duplicate link&quot; errors in request grouping when
vsl_buffer is increased</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2010">2010</a> - varnishadm CLI behaving weirdly</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2017">2017</a> - varnishncsa docfix: &quot;%r&quot; field is wrong</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2107">2107</a> - (docfix) HEAD requestes changed to GET</li>
</ul>
</div>
</div>
<div class="section" id="varnish-cache-4-1-4-beta1-2016-09-14">
<h1>Varnish Cache 4.1.4-beta1 (2016-09-14)</h1>
<ul class="simple">
<li>[varnishhist] Various improvements</li>
<li>[varnishtest] A <cite>cmd</cite> feature for custom shell-based checks</li>
<li>Documentation improvements (do_stream, sess_herd, timeout_linger, thread_pools)</li>
<li>[varnishtop] Documented behavior when both -p and -1 are specified</li>
</ul>
<div class="section" id="id94">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2027">2027</a> - Racy backend selection</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2024">2024</a> - panic vmod_rr_resolve() round_robin.c line 75 (be) != NULL</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2011">2011</a> - VBE.*.conn (concurrent connections to backend) not working as expected</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2008">2008</a> - Assert error in VBE_Delete()</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/2007">2007</a> - Update documentation part about CLI/management port authentication paramater</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1881">1881</a> - std.cache_req_body() w/ return(pipe) is broken</li>
</ul>
</div>
</div>
<div class="section" id="varnish-cache-4-1-3-2016-07-06">
<h1>Varnish Cache 4.1.3 (2016-07-06)</h1>
<ul class="simple">
<li>Be stricter when parsing request headers to harden against smuggling attacks.</li>
</ul>
</div>
<div class="section" id="varnish-cache-4-1-3-beta2-2016-06-28">
<h1>Varnish Cache 4.1.3-beta2 (2016-06-28)</h1>
<ul class="simple">
<li>New parameter <cite>vsm_free_cooldown</cite>. Specifies how long freed VSM
memory (shared log) will be kept around before actually being freed.</li>
<li>varnishncsa now accepts <cite>-L</cite> argument to configure the limit on incomplete
transactions kept. (Issue <a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1994">1994</a>)</li>
</ul>
<div class="section" id="id101">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1984">1984</a> - Make the counter vsm_cooling act according to spec</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1963">1963</a> - Avoid abort when changing to a VCL name which is a path</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1933">1933</a> - Don't trust dlopen refcounting</li>
</ul>
</div>
</div>
<div class="section" id="varnish-cache-4-1-3-beta1-2016-06-15">
<h1>Varnish Cache 4.1.3-beta1 (2016-06-15)</h1>
<ul class="simple">
<li>varnishncsa can now access and log backend requests. (PR #1905)</li>
<li>[varnishncsa] New output formatters %{Varnish:vxid}x and %{VSL:Tag}x.</li>
<li>[varnishlog] Added log tag BackendStart on backend transactions.</li>
<li>On SmartOS, use ports instead of epoll by default.</li>
<li>Add support for TCP Fast Open where available. Disabled by default.</li>
<li>[varnishtest] New syncronization primitive barriers added, improving
coordination when test cases call external programs.</li>
</ul>
<div class="section" id="id107">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1971">1971</a> - Add missing Wait_HeapDelete</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1967">1967</a> - [ncsa] Remove implicit line feed when using formatfile</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1955">1955</a> - 4.1.x sometimes duplicates Age and Accept-Ranges headers</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1954">1954</a> - Correctly handle HTTP/1.1 EOF response</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1953">1953</a> - Deal with fetch failures in ved_stripgzip</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1931">1931</a> - Allow VCL set Last-Modified to be used for I-M-S processing</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1928">1928</a> - req-&gt;task members must be set in case we get onto the waitinglist</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1924">1924</a> - Make std.log() and std.syslog() work from vcl_{init,fini}</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1919">1919</a> - Avoid ban lurker panic with empty olist</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1918">1918</a> - Correctly handle EOF responses with HTTP/1.1</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1912">1912</a> - Fix (insignificant) memory leak with mal-formed ESI directives.</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1904">1904</a> - Release memory instead of crashing on malformed ESI</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1885">1885</a> - [vmodtool] Method names should start with a period</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1879">1879</a> - Correct handling of duplicate headers on IMS header merge</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1878">1878</a> - Fix a ESI+gzip corner case which had escaped notice until now</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1873">1873</a> - Check for overrun before looking at the next vsm record</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1871">1871</a> - Missing error handling code in V1F_Setup_Fetch</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1869">1869</a> - Remove temporary directory iff called with -C</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1883">1883</a> - Only accept C identifiers as acls</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1855">1855</a> - Truncate output if it's wider than 12 chars</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1806">1806</a> - One minute delay on return (pipe) and a POST-Request</li>
<li><a class="reference external" href="https://github.com/varnishcache/varnish-cache/issues/1725">1725</a> - Revive the backend_conn counter</li>
</ul>
</div>
</div>
<div class="section" id="varnish-cache-4-1-2-2016-03-04">
<h1>Varnish Cache 4.1.2 (2016-03-04)</h1>
<ul class="simple">
<li>[vmods] vmodtool improvements for multiple VMODs in a single directory.</li>
</ul>
<div class="section" id="id130">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1860">1860</a> - ESI-related memory leaks</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1863">1863</a> - Don't reset the oc-&gt;ban pointer from BAN_CheckObject</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1864">1864</a> - Avoid panic if the lurker is working on a ban to be checked.</li>
</ul>
</div>
</div>
<div class="section" id="varnish-cache-4-1-2-beta2-2016-02-25">
<h1>Varnish Cache 4.1.2-beta2 (2016-02-25)</h1>
<ul class="simple">
<li>[vmods] Passing VCL ACL to a VMOD is now possible.</li>
<li>[vmods] VRT_MINOR_VERSION increase due to new function: VRT_acl_match()</li>
<li>Some test case stabilization fixes and minor documentation updates.</li>
<li>Improved handling of workspace exhaustion when fetching objects.</li>
</ul>
<div class="section" id="id134">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1858">1858</a> - Hit-for-pass objects are not IMS candidates</li>
</ul>
</div>
</div>
<div class="section" id="varnish-cache-4-1-2-beta1-2016-02-17">
<h1>Varnish Cache 4.1.2-beta1 (2016-02-17)</h1>
<ul class="simple">
<li>Be stricter when parsing a HTTP request to avoid potential
HTTP smuggling attacks against vulnerable backends.</li>
<li>Some fixes to minor/trivial issues found with clang AddressSanitizer.</li>
<li>Arithmetric on REAL data type in VCL is now possible.</li>
<li>vmodtool.py improvements to allow VMODs for 4.0 and 4.1 to share a source tree.</li>
<li>Off-by-one in WS_Reset() fixed.</li>
<li>&quot;https_scheme&quot; parameter added. Enables graceful handling of compound
request URLs with HTTPS scheme. (Bug <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1847">1847</a>)</li>
</ul>
<div class="section" id="id136">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1739">1739</a> - Workspace overflow handling in VFP_Push()</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1837">1837</a> - Error compiling VCL if probe is referenced before it is defined</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1841">1841</a> - Replace alien FD's with /dev/null rather than just closing them</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1843">1843</a> - Fail HTTP/1.0 POST and PUT requests without Content-Length</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1844">1844</a> - Correct ENUM handling in object constructors</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1851">1851</a> - Varnish 4.1.1 fails to build on i386</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1852">1852</a> - Add a missing VDP flush operation after ESI:includes.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1857">1857</a> - Fix timeout calculation for session herding.</li>
</ul>
</div>
</div>
<div class="section" id="varnish-cache-4-1-1-2016-01-28">
<h1>Varnish Cache 4.1.1 (2016-01-28)</h1>
<ul class="simple">
<li>No code changes since 4.1.1-beta2.</li>
</ul>
</div>
<div class="section" id="varnish-cache-4-1-1-beta2-2016-01-22">
<h1>Varnish Cache 4.1.1-beta2 (2016-01-22)</h1>
<ul class="simple">
<li>Improvements to VCL temperature handling added. This opens for reliably
deny warming a cooling VCL from a VMOD.</li>
</ul>
<div class="section" id="id146">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1802">1802</a> - Segfault after VCL change</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1825">1825</a> - Cannot Start Varnish After Just Restarting The Service</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1842">1842</a> - Handle missing waiting list gracefully.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1845">1845</a> - Handle whitespace after floats in test fields</li>
</ul>
</div>
</div>
<div class="section" id="varnish-cache-4-1-1-beta1-2016-01-15">
<h1>Varnish Cache 4.1.1-beta1 (2016-01-15)</h1>
<ul class="simple">
<li>Format of &quot;ban.list&quot; has changed slightly.</li>
<li>[varnishncsa] -w is now required when running deamonized.</li>
<li>[varnishncsa] Log format can now be read from file.</li>
<li>Port fields extracted from PROXY1 header now work as expected.</li>
<li>New VCL state &quot;busy&quot; introduced (mostly for VMOD writers).</li>
<li>Last traces of varnishreplay removed.</li>
<li>If-Modified-Since is now ignored if we have If-None-Match.</li>
<li>Zero Content-Length is no longer sent on 304 responses.</li>
<li>vcl_dir and vmod_dir now accept a colon separated list of directories.</li>
<li>Nested includes starting with &quot;./&quot; are relative to the including
VCL file now.</li>
</ul>
<div class="section" id="id151">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1796">1796</a> - Don't attempt to allocate a V1L from the workspace if it is overflowed.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1794">1794</a> - Fail if multiple -a arguments return the same suckaddr.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1763">1763</a> - Restart epoll_wait on EINTR error</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1788">1788</a> - ObjIter has terrible performance profile when busyobj != NULL</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1798">1798</a> - Varnish requests painfully slow with large files</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1816">1816</a> - Use a weak comparison function for If-None-Match</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1818">1818</a> - Allow grace-hits on hit-for-pass objects, [..]</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1821">1821</a> - Always slim private &amp; pass objects after delivery.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1823">1823</a> - Rush the objheader if there is a waiting list when it is deref'ed.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1826">1826</a> - Ignore 0 Content-Lengths in 204 responses</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1813">1813</a> - Fail if multiple -a arguments return the same suckaddr.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1810">1810</a> - Improve handling of HTTP/1.0 clients</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1807">1807</a> - Return 500 if we cannot decode the stored object into the resp.*</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1804">1804</a> - Log proxy related messages on the session, not on the request.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1801">1801</a> - Relax IP constant parsing</li>
</ul>
</div>
</div>
<div class="section" id="varnish-cache-4-1-0-2015-09-30">
<h1>Varnish Cache 4.1.0 (2015-09-30)</h1>
<ul class="simple">
<li>Documentation updates.</li>
<li>Stabilization fixes on testcase p00005.vtc.</li>
<li>Avoid compiler warning in zlib.</li>
<li>Bug <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1792">1792</a>: Avoid using fallocate() with -sfile on non-EXT4.</li>
</ul>
</div>
<div class="section" id="varnish-cache-4-1-0-beta1-2015-09-11">
<h1>Varnish Cache 4.1.0-beta1 (2015-09-11)</h1>
<ul class="simple">
<li>Redhat packaging files are now separate from the normal tree.</li>
<li>Client workspace overflow should now result in a 500 response
instead of panic.</li>
<li>[varnishstat] -w option has been retired.</li>
<li>libvarnishapi release number is increased.</li>
<li>Body bytes sent on ESI subrequests with gzip are now counted correctly.</li>
<li>[vmod-std] Data type conversion functions now take additional fallback argument.</li>
</ul>
<div class="section" id="id168">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1777">1777</a> - Disable speculative Range handling on streaming transactions.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1778">1778</a> - [varnishstat] Cast to integer to prevent negative values messing the statistics</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1781">1781</a> - Propagate gzip CRC upwards from nested ESI includes.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1783">1783</a> - Align code with RFC7230 section 3.3.3 which allows POST without a body.</li>
</ul>
</div>
</div>
<div class="section" id="varnish-cache-4-1-0-tp1-2015-07-08">
<h1>Varnish Cache 4.1.0-tp1 (2015-07-08)</h1>
<p>Changes between 4.0 and 4.1 are numerous. Please read the upgrade
section in the documentation for a general overview.</p>
</div>
<div class="section" id="changes-from-4-0-3-rc3-to-4-0-3-2015-02-17">
<h1>Changes from 4.0.3-rc3 to 4.0.3 (2015-02-17)</h1>
<ul class="simple">
<li>No changes.</li>
</ul>
</div>
<div class="section" id="changes-from-4-0-3-rc2-to-4-0-3-rc3-2015-02-11">
<h1>Changes from 4.0.3-rc2 to 4.0.3-rc3 (2015-02-11)</h1>
<ul class="simple">
<li>Superseded objects are now expired immediately.</li>
</ul>
<div class="section" id="id173">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1462">1462</a> - Use first/last log entry in varnishncsa.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1539">1539</a> - Avoid panic when expiry thread modifies a candidate object.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1637">1637</a> - Fail the fetch processing if the vep callback failed.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1665">1665</a> - Be more accurate when computing client RX_TIMEOUT.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1672">1672</a> - Do not panic on unsolicited 304 response to non-200 bereq.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-4-0-3-rc1-to-4-0-3-rc2-2015-01-28">
<h1>Changes from 4.0.3-rc1 to 4.0.3-rc2 (2015-01-28)</h1>
<ul class="simple">
<li>Assorted documentation updates.</li>
</ul>
<div class="section" id="id179">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1479">1479</a> - Fix out-of-tree builds.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1578">1566</a> - Escape VCL string question marks.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1616">1616</a> - Correct header file placement.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1620">1620</a> - Fail miss properly if out of backend threads. (Also <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1621">1621</a>)</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1628">1628</a> - Avoid dereferencing null in VBO_DerefBusyObj().</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1629">1629</a> - Ditch rest of waiting list on failure to reschedule.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1660">1660</a> - Don't attempt range delivery on a synth response</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-4-0-2-to-4-0-3-rc1-2015-01-15">
<h1>Changes from 4.0.2 to 4.0.3-rc1 (2015-01-15)</h1>
<ul class="simple">
<li>Support older autoconf (&lt; 2.63b) (el5)</li>
<li>A lot of minor documentation fixes.</li>
<li>bereq.uncacheable is now read-only.</li>
<li>obj.uncacheable is now readable in vcl_deliver.</li>
<li>[varnishadm] Prefer exact matches for backend.set_healthy. Bug <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1349">1349</a>.</li>
<li>Hard-coded -sfile default size is removed.</li>
<li>[packaging] EL6 packages are once again built with -O2.</li>
<li>[parameter] fetch_chunksize default is reduced to 16KB. (from 128KB)</li>
<li>Added std.time() which converts strings to VCL_TIME.</li>
<li>[packaging] packages now Provide strictABI (gitref) and ABI (VRT major/minor) for VMOD use.</li>
</ul>
<div class="section" id="id188">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1378">1378</a> - Properly escape non-printable characters in varnishncsa.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1596">1596</a> - Delay HSH_Complete() until the storage sanity functions has finished.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1506">1506</a> - Keep Content-Length from backend if we can.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1602">1602</a> - Fix a cornercase related to empty pass objects.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1607">1607</a> - Don't leak reqs on failure to revive from waitinglist.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1610">1610</a> - Update forgotten varnishlog example to 4.0 syntax.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1612">1612</a> - Fix a cornercase related to empty pass objects.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1623">1623</a> - Fix varnishhist -d segfault.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1636">1636</a> - Outdated paragraph in Vary: documentation</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1638">1638</a> - Fix panic when retrying a failed backend fetch.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1639">1639</a> - Restore the default SIGSEGV handler during pan_ic</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1647">1647</a> - Relax an assertion for the IMS update candidate object.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1648">1648</a> - Avoid partial IMS updates to replace old object.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1650">1650</a> - Collapse multiple X-Forwarded-For headers</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-4-0-2-rc1-to-4-0-2-2014-10-08">
<h1>Changes from 4.0.2-rc1 to 4.0.2 (2014-10-08)</h1>
<p>New since 4.0.2-rc1:</p>
<ul class="simple">
<li>[varnishlog] -k argument is back. (exit after n records)</li>
<li>[varnishadm] vcl.show is now listed in help.</li>
</ul>
</div>
<div class="section" id="changes-from-4-0-1-to-4-0-2-rc1-2014-09-23">
<h1>Changes from 4.0.1 to 4.0.2-rc1 (2014-09-23)</h1>
<p>New since 4.0.1:</p>
<ul class="simple">
<li>[libvmod-std] New function strstr() for matching substrings.</li>
<li>server.(hostname|identity) is now available in all VCL functions.</li>
<li>VCL variable type BYTES was added.</li>
<li><cite>workspace_client</cite> default is now 9k.</li>
<li>[varnishstat] Update interval can now be subsecond.</li>
<li>Document that reloading VCL does not reload a VMOD.</li>
<li>Guru meditation page is now valid HTML5.</li>
<li>[varnishstat] hitrate calculation is back.</li>
<li>New parameter <cite>group_cc</cite> adds a GID to the grouplist of
VCL compiler sandbox.</li>
<li>Parameter shm_reclen is now an alias for vsl_reclen.</li>
<li>Workspace overflows are now handled with a 500 client response.</li>
<li>VCL variable type added: HTTP, representing a HTTP header set.</li>
<li>It is now possible to return(synth) from vcl_deliver.</li>
<li>[varnishadm] vcl.show now has a -v option that output the
complete set of VCL and included VCL files.</li>
<li>RHEL7 packaging (systemd) was added.</li>
<li>[libvmod-std] querysort() fixed parameter limit has been lifted.</li>
<li>Fix small memory leak in ESI parser.</li>
<li>Fix unreported race/assert in V1D_Deliver().</li>
</ul>
<div class="section" id="id204">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1553">1553</a> - Fully reset workspace (incl. Vary state) before reusing it.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1551">1551</a> - Handle workspace exhaustion during purge.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1591">1591</a> - Group entries correctly in varnishtop.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1592">1592</a> - Bail out on workspace exhaustion in VRT_IP_string.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1538">1538</a> - Relax VMOD ABI check for release branches.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1584">1584</a> - Don't log garbage/non-HTTP requests. [varnishncsa]</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1407">1407</a> - Don't rename VSM file until child has started.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1466">1466</a> - Don't leak request structs on restart after waitinglist.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1580">1580</a> - Output warning if started without -b and -f. [varnishd]</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1583">1583</a> - Abort on fatal sandbox errors on Solaris. (Related: <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1572">1572</a>)</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1585">1585</a> - Handle fatal sandbox errors.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1572">1572</a> - Exit codes have been cleaned up.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1569">1569</a> - Order of symbols should not influence compilation result.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1579">1579</a> - Clean up type inference in VCL.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1578">1578</a> - Don't count Age twice when computing new object TTL.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1574">1574</a> - std.syslog() logged empty strings.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1555">1555</a> - autoconf editline/readline build issue.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1568">1568</a> - Skip NULL arguments when hashing.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1567">1567</a> - Compile on systems without SO_SNDTIMEO/SO_RCVTIMEO.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1512">1512</a> - Changes to bereq are lost between v_b_r and v_b_f.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1563">1563</a> - Increase varnishtest read timeout.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1561">1561</a> - Never call a VDP with zero length unless done.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1562">1562</a> - Fail correctly when rereading a failed client request body.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1521">1521</a> - VCL compilation fails on OSX x86_64.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1547">1547</a> - Panic when increasing shm_reclen.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1503">1503</a> - Document return(retry).</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1581">1581</a> - Don't log duplicate Begin records to shmlog.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1588">1588</a> - Correct timestamps on pipelined requests.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1575">1575</a> - Use all director backends when looking for a healthy one.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1577">1577</a> - Read the full request body if shunted to synth.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1532">1532</a> - Use correct VCL representation of reals.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1531">1531</a> - Work around libedit bug in varnishadm.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-4-0-0-to-4-0-1-2014-06-24">
<h1>Changes from 4.0.0 to 4.0.1 (2014-06-24)</h1>
<p>New since 4.0.0:</p>
<ul class="simple">
<li>New functions in vmod_std: real2time, time2integer, time2real, real.</li>
<li>Chunked requests are now supported. (pass)</li>
<li>Add std.querysort() that sorts GET query arguments. (from libvmod-boltsort)</li>
<li>Varnish will no longer reply with &quot;200 Not Modified&quot;.</li>
<li>Backend IMS is now only attempted when last status was 200.</li>
<li>Packaging now uses find-provides instead of find-requires. [redhat]</li>
<li>Two new counters: n_purges and n_obj_purged.</li>
<li>Core size can now be set from /etc/sysconfig/varnish [redhat]</li>
<li>Via header set is now RFC compliant.</li>
<li>Removed &quot;purge&quot; keyword in VCL. Use return(purge) instead.</li>
<li>fallback director is now documented.</li>
<li>%D format flag in varnishncsa is now truncated to an integer value.</li>
<li>persistent storage backend is now deprecated.
<a class="reference external" href="https://www.varnish-cache.org/docs/trunk/phk/persistent.html">https://www.varnish-cache.org/docs/trunk/phk/persistent.html</a></li>
<li>Added format flags %I (total bytes received) and %O (total bytes sent) for
varnishncsa.</li>
<li>python-docutils &gt;= 0.6 is now required.</li>
<li>Support year (y) as a duration in VCL.</li>
<li>VMOD ABI requirements are relaxed, a VMOD no longer have to be run on the
same git revision as it was compiled for. Replaced by a major/minor ABI counter.</li>
</ul>
<div class="section" id="id237">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1269">1269</a> - Use correct byte counters in varnishncsa when piping a request.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1524">1524</a> - Chunked requests should be pipe-able.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1530">1530</a> - Expire old object on successful IMS fetch.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1475">1475</a> - time-to-first-byte in varnishncsa was potentially dishonest.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1480">1480</a> - Porting guide for 4.0 is incomplete.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1482">1482</a> - Inherit group memberships of -u specified user.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1473">1473</a> - Fail correctly in configure when rst2man is not found.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1486">1486</a> - Truncate negative Age values to zero.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1488">1488</a> - Don't panic on high request rates.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1489">1489</a> - req.esi should only be available in client threads.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1490">1490</a> - Fix thread leak when reducing number of threads.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1491">1491</a> - Reorder backend connection close procedure to help test cases.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1498">1498</a> - Prefix translated VCL names to avoid name clashes.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1499">1499</a> - Don't leak an objcore when HSH_Lookup returns expired object.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1493">1493</a> - vcl_purge can return synth or restart.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1476">1476</a> - Cope with systems having sys/endian.h and endian.h.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1496">1496</a> - varnishadm should be consistent in argv ordering.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1494">1494</a> - Don't panic on VCL-initiated retry after a backend 500 error.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1139">1139</a> - Also reset keep (for IMS) time when purging.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1478">1478</a> - Avoid panic when delivering an object that expires during delivery.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1504">1504</a> - ACLs can be unreferenced with vcc_err_unref=off set.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1501">1501</a> - Handle that a director couldn't pick a backend.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1495">1495</a> - Reduce WRK_SumStat contention.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1510">1510</a> - Complain on symbol reuse in VCL.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1514">1514</a> - Document storage.NAME.free_space and .used_space [docs]</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1518">1518</a> - Suppress body on 304 response when using ESI.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1519">1519</a> - Round-robin director does not support weight. [docs]</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-4-0-0-beta1-to-4-0-0-2014-04-10">
<h1>Changes from 4.0.0 beta1 to 4.0.0 (2014-04-10)</h1>
<p>New since 4.0.0-beta1:</p>
<ul class="simple">
<li>improved varnishstat documentation.</li>
<li>In VCL, req.backend_hint is available in vcl_hit</li>
<li>ncurses is now a dependency.</li>
</ul>
<div class="section" id="id264">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1469">1469</a> - Fix build error on PPC</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1468">1468</a> - Set ttl=0 on failed objects</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1462">1462</a> - Handle duplicate ReqURL in varnishncsa.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1467">1467</a> - Fix missing clearing of oc-&gt;busyobj on HSH_Fail.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-4-0-0-tp2-to-4-0-0-beta1-2014-03-27">
<h1>Changes from 4.0.0 TP2 to 4.0.0 beta1 (2014-03-27)</h1>
<p>New since TP2:</p>
<ul class="simple">
<li>Previous always-appended code called default.vcl is now called builtin.vcl.
The new example.vcl is recommended as a starting point for new users.</li>
<li>vcl_error is now called vcl_synth, and does not any more mandate closing the
client connection.</li>
<li>New VCL function vcl_backend_error, where you can change the 503 prepared if
all your backends are failing. This can then be cached as a regular object.</li>
<li>Keyword &quot;remove&quot; in VCL is replaced by &quot;unset&quot;.</li>
<li>new timestamp and accounting records in varnishlog.</li>
<li>std.timestamp() is introduced.</li>
<li>stored objects are now read only, meaning obj.hits now counts per objecthead
instead. obj.lastuse saw little use and has been removed.</li>
<li>builtin VCL now does return(pipe) for chunked POST and PUT requests.</li>
<li>python-docutils and rst2man are now build requirements.</li>
<li>cli_timeout is now 60 seconds to avoid slaughtering the child process in
times of high IO load/scheduling latency.</li>
<li>return(purge) from vcl_recv is now valid.</li>
<li>return(hash) is now the default return action from vcl_recv.</li>
<li>req.backend is now req.backend_hint. beresp.storage is beresp.storage_hint.</li>
</ul>
<div class="section" id="id269">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1460">1460</a> - tools now use the new timestamp format.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1450">1450</a> - varnishstat -l segmentation fault.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1320">1320</a> - Work around Content-Length: 0 and Content-Encoding: gzip gracefully.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1458">1458</a> - Panic on busy object.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1417">1417</a> - Handle return(abandon) in vcl_backend_response.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1455">1455</a> - vcl_pipe now sets Connection: close by default on backend requests.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1454">1454</a> - X-Forwarded-For is now done in C, before vcl_recv is run.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1436">1436</a> - Better explanation when missing an import in VCL.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1440">1440</a> - Serve ESI-includes from a different backend.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1441">1441</a> - Incorrect grouping when logging ESI subrequests.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1434">1434</a> - std.duration can now do ms/milliseconds.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1419">1419</a> - Don't put objcores on the ban list until they go non-BUSY.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1405">1405</a> - Ban lurker does not always evict all objects.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-4-0-0-tp1-to-4-0-0-tp2-2014-01-23">
<h1>Changes from 4.0.0 TP1 to 4.0.0 TP2 (2014-01-23)</h1>
<div class="section" id="new-since-from-4-0-0-tp1">
<h2>New since from 4.0.0 TP1</h2>
<ul class="simple">
<li>New VCL_BLOB type to pass binary data between VMODs.</li>
<li>New format for VMOD description files. (.vcc)</li>
</ul>
</div>
<div class="section" id="id283">
<h2>Bugs fixed</h2>
<ul class="simple">
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1404">1404</a> - Don't send Content-Length on 304 Not Modified responses.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1401">1401</a> - Varnish would crash when retrying a backend fetch too many times.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1399">1399</a> - Memory get freed while in use by another thread/object</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1398">1398</a> - Fix NULL deref related to a backend we don't know any more.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1397">1397</a> - Crash on backend fetch while LRUing.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1395">1395</a> - End up in vcl_error also if fetch fails vcl_backend_response.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1391">1391</a> - Client abort and retry during a streaming fetch would make Varnish assert.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1390">1390</a> - Fix assert if the ban lurker is overtaken by new duplicate bans.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1385">1385</a> - ban lurker doesn't remove (G)one bans</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1383">1383</a> - varnishncsa logs requests for localhost regardless of host header.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1382">1382</a> - varnishncsa prints nulls as part of request string.</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1381">1381</a> - Ensure vmod_director is installed</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1323">1323</a> - Add a missing boundary check for Range requests</li>
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1268">1268</a> - shortlived parameter now uses TTL+grace+keep instead of just TTL.</li>
<li>Fix build error on OpenBSD (TCP_KEEP)</li>
<li>n_object wasn't being decremented correctly on object expire.</li>
<li>Example default.vcl in distribution is now 4.0-ready.</li>
</ul>
</div>
<div class="section" id="open-issues">
<h2>Open issues</h2>
<ul class="simple">
<li><a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1405">1405</a> - Ban lurker does not always evict all objects.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-3-0-7-rc1-to-3-0-7-2015-03-23">
<h1>Changes from 3.0.7-rc1 to 3.0.7 (2015-03-23)</h1>
<ul class="simple">
<li>No changes.</li>
</ul>
</div>
<div class="section" id="changes-from-3-0-6-to-3-0-7-rc1-2015-03-18">
<h1>Changes from 3.0.6 to 3.0.7-rc1 (2015-03-18)</h1>
<ul class="simple">
<li>Requests with multiple Content-Length headers will now fail.</li>
<li>Stop recognizing a single CR (r) as a HTTP line separator.
This opened up a possible cache poisoning attack in stacked installations
where sslterminator/varnish/backend had different CR handling.</li>
<li>Improved error detection on master-child process communication, leading to
faster recovery (child restart) if communication loses sync.</li>
<li>Fix a corner-case where Content-Length was wrong for HTTP 1.0 clients,
when using gzip and streaming. Bug <a class="reference external" href="http://varnish-cache.org/trac/ticket/1627">1627</a>.</li>
<li>More robust handling of hop-by-hop headers.</li>
<li>[packaging] Coherent Redhat pidfile in init script. Bug <a class="reference external" href="http://varnish-cache.org/trac/ticket/1690">1690</a>.</li>
<li>Avoid memory leak when adding bans.</li>
</ul>
</div>
<div class="section" id="changes-from-3-0-6rc1-to-3-0-6-2014-10-16">
<h1>Changes from 3.0.6rc1 to 3.0.6 (2014-10-16)</h1>
<ul class="simple">
<li>Minor changes to documentation.</li>
<li>[varnishadm] Add termcap workaround for libedit. Bug <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1531">1531</a>.</li>
</ul>
</div>
<div class="section" id="changes-from-3-0-5-to-3-0-6rc1-2014-06-24">
<h1>Changes from 3.0.5 to 3.0.6rc1 (2014-06-24)</h1>
<ul class="simple">
<li>Document storage.&lt;name&gt;.* VCL variables. Bug <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1514">1514</a>.</li>
<li>Fix memory alignment panic when http_max_hdr is not a multiple of 4. Bug <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1327">1327</a>.</li>
<li>Avoid negative ReqEnd timestamps with ESI. Bug <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1297">1297</a>.</li>
<li>%D format for varnishncsa is now an integer (as documented)</li>
<li>Fix compile errors with clang.</li>
<li>Clear objectcore flags earlier in ban lurker to avoid spinning thread. Bug <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1470">1470</a>.</li>
<li>Patch embedded jemalloc to avoid segfault. Bug <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1448">1448</a>.</li>
<li>Allow backend names to start with if, include or else. Bug <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1439">1439</a>.</li>
<li>Stop handling gzip after gzip body end. Bug <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1086">1086</a>.</li>
<li>Document %D and %T for varnishncsa.</li>
</ul>
</div>
<div class="section" id="changes-from-3-0-5-rc-1-to-3-0-5-2013-12-02">
<h1>Changes from 3.0.5 rc 1 to 3.0.5 (2013-12-02)</h1>
<div class="section" id="varnishd">
<h2>varnishd</h2>
<ul class="simple">
<li>Always check the local address of a socket.  This avoids a crash if
server.ip is accessed after a client has closed the connection. <cite>Bug #1376</cite></li>
</ul>
</div>
</div>
<div class="section" id="changes-from-3-0-4-to-3-0-5-rc-1">
<h1>Changes from 3.0.4 to 3.0.5 rc 1</h1>
<div class="section" id="id308">
<h2>varnishd</h2>
<ul class="simple">
<li>Stop printing error messages on ESI parse errors</li>
<li>Fix a problem where Varnish would segfault if the first part of a
synthetic page was NULL.  <cite>Bug #1287</cite></li>
<li>If streaming was used, you could in some cases end up with duplicate
content headers being sent to clients. <cite>Bug #1272</cite></li>
<li>If we receive a completely garbled request, don't pass through
vcl_error, since we could then end up in vcl_recv through a restart
and things would go downhill from there. <cite>Bug #1367</cite></li>
<li>Prettify backtraces on panic slightly.</li>
</ul>
</div>
<div class="section" id="varnishlog">
<h2>varnishlog</h2>
<ul class="simple">
<li>Correct an error where -m, -c and -b would interact badly, leading
to lack of matches.  Also, emit BackendXID to signify the start of a
transaction. <cite>Bug #1325</cite></li>
</ul>
</div>
<div class="section" id="varnishadm">
<h2>varnishadm</h2>
<ul class="simple">
<li>Handle input from stdin properly. <cite>Bug #1314</cite></li>
</ul>
</div>
</div>
<div class="section" id="changes-from-3-0-4-rc-1-to-3-0-4-2013-06-14">
<h1>Changes from 3.0.4 rc 1 to 3.0.4 (2013-06-14)</h1>
<div class="section" id="id309">
<h2>varnishd</h2>
<ul class="simple">
<li>Set the waiter pipe as non-blocking and record overflows.  <cite>Bug
#1285</cite></li>
<li>Fix up a bug in the ACL compile code that could lead to false
negatives.  CVE-2013-4090.    <cite>Bug #1312</cite></li>
<li>Return an error if the client sends multiple Host headers.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-3-0-3-to-3-0-4-rc-1">
<h1>Changes from 3.0.3 to 3.0.4 rc 1</h1>
<div class="section" id="id310">
<h2>varnishd</h2>
<ul class="simple">
<li>Fix error handling when uncompressing fetched objects for ESI
processing. <cite>Bug #1184</cite></li>
<li>Be clearer about which timeout was reached in logs.</li>
<li>Correctly decrement n_waitinglist counter.  <cite>Bug #1261</cite></li>
<li>Turn off Nagle/set TCP_NODELAY.</li>
<li>Avoid panic on malformed Vary headers.  <cite>Bug #1275</cite></li>
<li>Increase the maximum length of backend names.  <cite>Bug #1224</cite></li>
<li>Add support for banning on http.status.  <cite>Bug #1076</cite></li>
<li>Make hit-for-pass correctly prefer the transient storage.</li>
</ul>
</div>
<div class="section" id="id311">
<h2>varnishlog</h2>
<ul class="simple">
<li>If -m, but neither -b or -c is given, assume both.  This filters out
a lot of noise when -m is used to filter.  <cite>Bug #1071</cite></li>
</ul>
</div>
<div class="section" id="id312">
<h2>varnishadm</h2>
<ul class="simple">
<li>Improve tab completion and require libedit/readline to build.</li>
</ul>
</div>
<div class="section" id="varnishtop">
<h2>varnishtop</h2>
<ul class="simple">
<li>Reopen log file if Varnish is restarted.</li>
</ul>
</div>
<div class="section" id="varnishncsa">
<h2>varnishncsa</h2>
<ul class="simple">
<li>Handle file descriptors above 64k (by ignoring them).  Prevents a
crash in some cases with corrupted shared memory logs.</li>
<li>Add %D and %T support for more timing information.</li>
</ul>
</div>
<div class="section" id="other">
<h2>Other</h2>
<ul class="simple">
<li>Documentation updates.</li>
<li>Fixes for OSX</li>
<li>Disable PCRE JIT-er, since it's broken in some PCRE versions, at
least on i386.</li>
<li>Make libvarnish prefer exact hits when looking for VSL tags.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-3-0-2-to-3-0-3-2012-08-20">
<h1>Changes from 3.0.2 to 3.0.3 (2012-08-20)</h1>
<div class="section" id="id313">
<h2>varnishd</h2>
<ul class="simple">
<li>Fix a race on the n_sess counter. This race made varnish do excessive
session workspace allocations. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/897">Bug #897</a>.</li>
<li>Fix some crashes in the gzip code when it runs out of memory. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1037">Bug #1037</a>.
<a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1043">Bug #1043</a>. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1044">Bug #1044</a>.</li>
<li>Fix a bug where the regular expression parser could end up in an infinite
loop. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1047">Bug #1047</a>.</li>
<li>Fix a memory leak in the regex code.</li>
<li>DNS director now uses port 80 by default if not specified.</li>
<li>Introduce <cite>idle_send_timeout</cite> and increase default value for <cite>send_timeout</cite>
to 600s. This allows a long send timeout for slow clients while still being
able to disconnect idle clients.</li>
<li>Fix an issue where &lt;esi:remove&gt; did not remove HTML comments. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1092">Bug #1092</a>.</li>
<li>Fix a crash when passing with streaming on.</li>
<li>Fix a crash in the idle session timeout code.</li>
<li>Fix an issue where the poll waiter did not timeout clients if all clients
were idle. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1023">Bug #1023</a>.</li>
<li>Log regex errors instead of crashing.</li>
<li>Introduce <cite>pcre_match_limit</cite>, and <cite>pcre_match_limit_recursion</cite> parameters.</li>
<li>Add CLI commands to manually control health state of a backend.</li>
<li>Fix an issue where the s_bodybytes counter is not updated correctly on
gunzipped delivery.</li>
<li>Fix a crash when we couldn't allocate memory for a fetched object.
<a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1100">Bug #1100</a>.</li>
<li>Fix an issue where objects could end up in the transient store with a
long TTL, when memory could not be allocated for them in the requested
store. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1140">Bug #1140</a>.</li>
<li>Activate req.hash_ignore_busy when req.hash_always_miss is activated.
<a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1073">Bug #1073</a>.</li>
<li>Reject invalid tcp port numbers for listen address. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1035">Bug #1035</a>.</li>
<li>Enable JIT for better performing regular expressions. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1080">Bug #1080</a>.</li>
<li>Return VCL errors in exit code when using -C. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1069">Bug #1069</a>.</li>
<li>Stricter validation of acl syntax, to avoid a crash with 5-octet IPv4
addresses. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1126">Bug #1126</a>.</li>
<li>Fix a crash when first argument to regsub was null. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1125">Bug #1125</a>.</li>
<li>Fix a case where varnish delivered corrupt gzip content when using ESI.
<a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1109">Bug #1109</a>.</li>
<li>Fix a case where varnish didn't remove the old Date header and served
it alongside the varnish-generated Date header. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1104">Bug #1104</a>.</li>
<li>Make saint mode work, for the case where we have no object with that hash.
<a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1091">Bug #1091</a>.</li>
<li>Don't save the object body on hit-for-pass objects.</li>
<li>n_ban_gone counter added to count the number of &quot;gone&quot; bans.</li>
<li>Ban lurker rewritten to properly sleep when no bans are present, and
otherwise to process the list at the configured speed.</li>
<li>Fix a case where varnish delivered wrong content for an uncompressed page
with compressed ESI child. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1029">Bug #1029</a>.</li>
<li>Fix an issue where varnish runs out of thread workspace when processing
many ESI includes on an object. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1038">Bug #1038</a>.</li>
<li>Fix a crash when streaming was enabled for an empty body.</li>
<li>Better error reporting for some fetch errors.</li>
<li>Small performance optimizations.</li>
</ul>
</div>
<div class="section" id="id314">
<h2>varnishncsa</h2>
<ul class="simple">
<li>Support for tn in varnishncsa format strings.</li>
<li>Add new format: %{VCL_Log:foo}x which output key:value from std.log() in
VCL.</li>
<li>Add user-defined date formatting, using %{format}t.</li>
</ul>
</div>
<div class="section" id="varnishtest">
<h2>varnishtest</h2>
<ul class="simple">
<li>resp.body is now available for inspection.</li>
<li>Make it possible to test for the absence of an HTTP header. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1062">Bug #1062</a>.</li>
<li>Log the full panic message instead of shortening it to 512 characters.</li>
</ul>
</div>
<div class="section" id="varnishstat">
<h2>varnishstat</h2>
<ul class="simple">
<li>Add json output (-j).</li>
</ul>
</div>
<div class="section" id="id315">
<h2>Other</h2>
<ul class="simple">
<li>Documentation updates.</li>
<li>Bump minimum number of threads to 50 in RPM packages.</li>
<li>RPM packaging updates.</li>
<li>Fix some compilation warnings on Solaris.</li>
<li>Fix some build issues on Open/Net/DragonFly-BSD.</li>
<li>Fix build on FreeBSD 10-current.</li>
<li>Fix libedit detection on *BSD OSes. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1003">Bug #1003</a>.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-3-0-2-rc-1-to-3-0-2-2011-10-26">
<h1>Changes from 3.0.2 rc 1 to 3.0.2 (2011-10-26)</h1>
<div class="section" id="id316">
<h2>varnishd</h2>
<ul class="simple">
<li>Make the size of the synthetic object workspace equal to
<cite>http_resp_size</cite> and add workaround to avoid a crash when setting
too long response strings for synthetic objects.</li>
<li>Ensure the ban lurker always sleeps the advertised 1 second when it
does not have anything to do.</li>
<li>Remove error from <cite>vcl_deliver</cite>.  Previously this would assert while
it will now give a syntax error.</li>
</ul>
</div>
<div class="section" id="id317">
<h2>varnishncsa</h2>
<ul class="simple">
<li>Add default values for some fields when logging incomplete records
and document the default values.</li>
</ul>
</div>
<div class="section" id="id318">
<h2>Other</h2>
<ul class="simple">
<li>Documentation updates</li>
<li>Some Solaris portability updates.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-3-0-1-to-3-0-2-rc-1-2011-10-06">
<h1>Changes from 3.0.1 to 3.0.2 rc 1 (2011-10-06)</h1>
<div class="section" id="id319">
<h2>varnishd</h2>
<ul class="simple">
<li>Only log the first 20 bytes of extra headers to prevent overflows.</li>
<li>Fix crasher bug which sometimes happened if responses are queued and
the backend sends us Vary. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/994">Bug #994</a>.</li>
<li>Log correct size of compressed when uncompressing them for clients
that do not support compression. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/996">Bug #996</a>.</li>
<li>Only send Range responses if we are going to send a body. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1007">Bug #1007</a>.</li>
<li>When varnishd creates a storage file, also unlink it to avoid
leaking disk space over time.  <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1008">Bug #1008</a>.</li>
<li>The default size of the <cite>-s file</cite> parameter has been changed to
100MB instead of 50% of the available disk space.</li>
<li>The limit on the number of objects we remove from the cache to make
room for a new one was mistakenly lowered to 10 in 3.0.1.  This has
been raised back to 50.  <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1012">Bug #1012</a>.</li>
<li><cite>http_req_size</cite> and <cite>http_resp_size</cite> have been increased to 8192
bytes.  This better matches what other HTTPds have.   <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/1016">Bug #1016</a>.</li>
</ul>
</div>
<div class="section" id="vcl">
<h2>VCL</h2>
<ul class="simple">
<li>Allow relational comparisons of floating point types.</li>
<li>Make it possible for VMODs to fail loading and so cause the VCL
loading to fail.</li>
</ul>
</div>
<div class="section" id="id320">
<h2>varnishncsa</h2>
<ul class="simple">
<li>Fixed crash when client was sending illegal HTTP headers.</li>
<li><cite>%{Varnish:handling}</cite> in format strings was broken, this has been
fixed.</li>
</ul>
</div>
<div class="section" id="id321">
<h2>Other</h2>
<ul class="simple">
<li>Documentation updates</li>
<li>Some Solaris portability updates.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-3-0-1-rc-1-to-3-0-1-2011-08-30">
<h1>Changes from 3.0.1 rc 1 to 3.0.1 (2011-08-30)</h1>
<div class="section" id="id322">
<h2>varnishd</h2>
<ul class="simple">
<li>Fix crash in streaming code.</li>
<li>Add <cite>fallback</cite> director, as a variant of the <cite>round-robin</cite>
director.</li>
<li>The parameter <cite>http_req_size</cite> has been reduced on 32 bit machines.</li>
</ul>
</div>
<div class="section" id="id323">
<h2>VCL</h2>
<ul class="simple">
<li>Disallow error in the <cite>vcl_init</cite> and <cite>vcl_fini</cite> VCL functions.</li>
</ul>
</div>
<div class="section" id="id324">
<h2>varnishncsa</h2>
<ul class="simple">
<li>Fixed crash when using <cite>-X</cite>.</li>
<li>Fix error when the time to first byte was in the format string.</li>
</ul>
</div>
<div class="section" id="id325">
<h2>Other</h2>
<ul class="simple">
<li>Documentation updates</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-3-0-0-to-3-0-1-rc-1-2011-08-24">
<h1>Changes from 3.0.0 to 3.0.1 rc 1 (2011-08-24)</h1>
<div class="section" id="id326">
<h2>varnishd</h2>
<ul class="simple">
<li>Avoid sending an empty end-chunk when sending bodyless responses.</li>
<li><cite>http_resp_hdr_len</cite> and <cite>http_req_hdr_len</cite> were set to too low
values leading to clients receiving <cite>HTTP 400 Bad Request</cite> errors.
The limit has been increased and the error code is now <cite>HTTP 413
Request entity too large</cite>.</li>
<li>Objects with grace or keep set were mistakenly considered as
candidates for the transient storage.  They now have their grace and
keep limited to limit the memory usage of the transient stevedore.</li>
<li>If a request was restarted from <cite>vcl_miss</cite> or <cite>vcl_pass</cite> it would
crash.  This has been fixed.  <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/965">Bug #965</a>.</li>
<li>Only the first few clients waiting for an object from the backend
would be woken up when object arrived and this lead to some clients
getting stuck for a long time.  This has now been fixed. <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/963">Bug #963</a>.</li>
<li>The <cite>hash</cite> and <cite>client</cite> directors would mistakenly retry fetching an
object from the same backend unless health probes were enabled.
This has been fixed and it will now retry a different backend.</li>
</ul>
</div>
<div class="section" id="id327">
<h2>VCL</h2>
<ul class="simple">
<li>Request specific variables such as <cite>client.*</cite> and <cite>server.*</cite> are now
correctly marked as not available in <cite>vcl_init</cite> and <cite>vcl_fini</cite>.</li>
<li>The VCL compiler would fault if two IP comparisons were done on the
same line.  This now works correctly.  <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/948">Bug #948</a>.</li>
</ul>
</div>
<div class="section" id="id328">
<h2>varnishncsa</h2>
<ul class="simple">
<li>Add support for logging arbitrary request and response headers.</li>
<li>Fix crashes if <cite>hitmiss</cite> and <cite>handling</cite> have not yet been set.</li>
<li>Avoid printing partial log lines if there is an error in a format
string.</li>
<li>Report user specified format string errors better.</li>
</ul>
</div>
<div class="section" id="id329">
<h2>varnishlog</h2>
<ul class="simple">
<li><cite>varnishlog -r</cite> now works correctly again and no longer opens the
shared log file of the running Varnish.</li>
</ul>
</div>
<div class="section" id="id330">
<h2>Other</h2>
<ul class="simple">
<li>Various documentation updates.</li>
<li>Minor compilation fixes for newer compilers.</li>
<li>A bug in the ESI entity replacement parser has been fixed.  <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/961">Bug
#961</a>.</li>
<li>The ABI of VMODs are now checked.  This will require a rebuild of
all VMODs against the new version of Varnish.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-3-0-beta-2-to-3-0-0-2011-06-16">
<h1>Changes from 3.0 beta 2 to 3.0.0 (2011-06-16)</h1>
<div class="section" id="id331">
<h2>varnishd</h2>
<ul class="simple">
<li>Avoid sending an empty end-chunk when sending bodyless responses.</li>
</ul>
</div>
<div class="section" id="id332">
<h2>VCL</h2>
<ul class="simple">
<li>The <cite>synthetic</cite> keyword has now been properly marked as only
available in <cite>vcl_deliver</cite>.  <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/936">Bug #936</a>.</li>
</ul>
</div>
<div class="section" id="id333">
<h2>varnishadm</h2>
<ul class="simple">
<li>Fix crash if the secret file was unreadable.  <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/935">Bug #935</a>.</li>
<li>Always exit if <cite>varnishadm</cite> can't connect to the backend for any
reason.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-3-0-beta-1-to-3-0-beta-2">
<h1>Changes from 3.0 beta 1 to 3.0 beta 2</h1>
<div class="section" id="id334">
<h2>varnishd</h2>
<ul class="simple">
<li>thread_pool_min and thread_pool_max now each refer to the number of
threads per pool, rather than being inconsistent as they were
before.</li>
<li>307 Temporary redirect is now considered cacheable.  <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/908">Bug #908</a>.</li>
<li>The <cite>stats</cite> command has been removed from the CLI interface.  With
the new counters, it would mean implementing more and more of
varnishstat in the master CLI process and the CLI is
single-threaded so we do not want to do this work there in the first
place.  Use varnishstat instead.</li>
</ul>
</div>
<div class="section" id="id335">
<h2>VCL</h2>
<ul class="simple">
<li>VCL now treats null arguments (unset headers for instance) as empty
strings.  <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/913">Bug #913</a>.</li>
<li>VCL now has vcl_init and vcl_fini functions that are called when a
given VCL has been loaded and unloaded.</li>
<li>There is no longer any interpolation of the right hand side in bans
where the ban is a single string.  This was confusing and you now
have to make sure bits are inside or outside string context as
appropriate.</li>
<li>Varnish is now stricter in enforcing no duplication of probes,
backends and ACLs.</li>
</ul>
</div>
<div class="section" id="id336">
<h2>varnishncsa</h2>
<ul class="simple">
<li>varnishncsa now ignores piped requests, since we have no way of
knowing their return status.</li>
</ul>
</div>
<div class="section" id="vmods">
<h2>VMODs</h2>
<ul class="simple">
<li>The std module now has proper documentation, including a manual page</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-2-1-5-to-3-0-beta-1">
<h1>Changes from 2.1.5 to 3.0 beta 1</h1>
<div class="section" id="upcoming-changes">
<h2>Upcoming changes</h2>
<ul class="simple">
<li>The interpretation of bans will change slightly between 3.0 beta 1
and 3.0 release.  Currently, doing <tt class="docutils literal"><span class="pre">ban(&quot;req.url</span> == req.url&quot;)</tt>
will cause the right hand req.url to be interpreted in the context
of the request creating the ban.  This will change so you will have
to do <tt class="docutils literal"><span class="pre">ban(&quot;req.url</span> == &quot; + req.url)</tt> instead.  This syntax already
works and is recommended.</li>
</ul>
</div>
<div class="section" id="id337">
<h2>varnishd</h2>
<ul class="simple">
<li>Add streaming on <tt class="docutils literal">pass</tt> and <tt class="docutils literal">miss</tt>.  This is controlled by the
<tt class="docutils literal">beresp.do_stream</tt> boolean.  This includes support for
compression/uncompression.</li>
<li>Add support for ESI and gzip.</li>
<li>Handle objects larger than 2G.</li>
<li>HTTP Range support is now enabled by default</li>
<li>The ban lurker is enabled by default</li>
<li>if there is a backend or director with the name <tt class="docutils literal">default</tt>, use
that as the default backend, otherwise use the first one listed.</li>
<li>Add many more stats counters.  Amongst those, add per storage
backend stats and per-backend statistics.</li>
<li>Syslog the platform we are running on</li>
<li>The <tt class="docutils literal"><span class="pre">-l</span></tt> (shared memory log file) argument has been changed,
please see the varnishd manual for the new syntax.</li>
<li>The <tt class="docutils literal"><span class="pre">-S</span></tt> and <tt class="docutils literal"><span class="pre">-T</span></tt> arguments are now stored in the shmlog</li>
<li>Fix off-by-one error when exactly filling up the workspace.  <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/693">Bug #693</a>.</li>
<li>Make it possible to name storage backends.  The names have to be
unique.</li>
<li>Update usage output to match the code.  <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/683">Bug #683</a></li>
<li>Add per-backend health information to shared memory log.</li>
<li>Always recreate the shared memory log on startup.</li>
<li>Add a <tt class="docutils literal">vcl_dir</tt> parameter.  This is used to resolve relative path
names for <tt class="docutils literal">vcl.load</tt> and <tt class="docutils literal">include</tt> in .vcl files.</li>
<li>Make it possible to specify <tt class="docutils literal"><span class="pre">-T</span> :0</tt>.  This causes varnishd to look
for a free port automatically.  The port is written in the shared
memory log so varnishadm can find it.</li>
<li>Classify locks into kinds and collect stats for each kind,
recording the data in the shared memory log.</li>
<li>Auto-detect necessary flags for pthread support and <tt class="docutils literal">VCC_CC</tt>
flags.  This should make Varnish somewhat happier on Solaris.  <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/663">Bug
#663</a></li>
<li>The <tt class="docutils literal">overflow_max</tt> parameter has been renamed to <tt class="docutils literal">queue_max</tt>.</li>
<li>If setting a parameter fails, report which parameter failed as this
is not obvious during startup.</li>
<li>Add a parameter named <tt class="docutils literal">shortlived</tt>.  Objects whose TTL is less
than the parameter go into transient (malloc) storage.</li>
<li>Reduce the default <tt class="docutils literal">thread_add_delay</tt> to 2ms.</li>
<li>The <tt class="docutils literal">max_esi_includes</tt> parameter has been renamed to
<tt class="docutils literal">max_esi_depth</tt>.</li>
<li>Hash string components are now logged by default.</li>
<li>The default connect timeout parameter has been increased to 0.7
seconds.</li>
<li>The <tt class="docutils literal">err_ttl</tt> parameter has been removed and is replaced by a
setting in default.vcl.</li>
<li>The default <tt class="docutils literal">send_timeout</tt> parameter has been reduced to 1 minute.</li>
<li>The default <tt class="docutils literal">ban_lurker</tt> sleep has been set to 10ms.</li>
<li>When an object is banned, make sure to set its grace to 0 as well.</li>
<li>Add <tt class="docutils literal">panic.show</tt> and <tt class="docutils literal">panic.clear</tt> CLI commands.</li>
<li>The default <tt class="docutils literal">http_resp_hdr_len</tt> and <tt class="docutils literal">http_req_hdr_len</tt> has been
increased to 2048 bytes.</li>
<li>If <tt class="docutils literal">vcl_fetch</tt> results in <tt class="docutils literal">restart</tt> or <tt class="docutils literal">error</tt>, close the
backend connection rather than fetching the object.</li>
<li>If allocating storage for an object, try reducing the chunk size
before evicting objects to make room.  <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/880">Bug #880</a></li>
<li>Add <tt class="docutils literal">restart</tt> from <tt class="docutils literal">vcl_deliver</tt>.  <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/411">Bug #411</a></li>
<li>Fix an off-by-up-to-one-minus-epsilon bug where if an object from
the backend did not have a last-modified header we would send out a
304 response which did include a <tt class="docutils literal"><span class="pre">Last-Modified</span></tt> header set to
when we received the object.  However, we would compare the
timestamp to the fractional second we got the object, meaning any
request with the exact timestamp would get a <tt class="docutils literal">200</tt> response rather
than the correct <tt class="docutils literal">304</tt>.</li>
<li>Fix a race condition in the ban lurker where a serving thread and
the lurker would both look at an object at the same time, leading to
Varnish crashing.</li>
<li>If a backend sends a <tt class="docutils literal"><span class="pre">Content-Length</span></tt> header and we are streaming and
we are not uncompressing it, send the <tt class="docutils literal"><span class="pre">Content-Length</span></tt> header on,
allowing browsers to diplay a progress bar.</li>
<li>All storage must be at least 1M large.  This is to prevent
administrator errors when specifying the size of storage where the
admin might have forgotten to specify units.</li>
</ul>
</div>
<div class="section" id="tools">
<h2>Tools</h2>
<div class="section" id="common">
<h3>common</h3>
<ul class="simple">
<li>Add an <tt class="docutils literal"><span class="pre">-m</span> <span class="pre">$tag:$regex</span></tt> parameter, used for selecting some
transactions.  The parameter can be repeated, in which case it is
logically and-ed together.</li>
</ul>
</div>
<div class="section" id="id338">
<h3>varnishadm</h3>
<ul class="simple">
<li>varnishadm will now pick up the -S and -T arguments from the shared
memory log, meaning just running it without any arguments will
connect to the running varnish.  <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/875">Bug #875</a></li>
<li>varnishadm now accepts an -n argument to specify the location of the
shared memory log file</li>
<li>add libedit support</li>
</ul>
</div>
<div class="section" id="id339">
<h3>varnishstat</h3>
<ul class="simple">
<li>reopen shared memory log if the varnishd process is restarted.</li>
<li>Improve support for selecting some, but not all fields using the
<tt class="docutils literal"><span class="pre">-f</span></tt> argument. Please see the documentation for further details on
the use of <tt class="docutils literal"><span class="pre">-f</span></tt>.</li>
<li>display per-backend health information</li>
</ul>
</div>
<div class="section" id="id340">
<h3>varnishncsa</h3>
<ul class="simple">
<li>Report error if called with <tt class="docutils literal"><span class="pre">-i</span></tt> and <tt class="docutils literal"><span class="pre">-I</span></tt> as they do not make
any sense for varnishncsa.</li>
<li>Add custom log formats, specified with <tt class="docutils literal"><span class="pre">-F</span></tt>.  Most of the Apache
log formats are supported, as well as some Varnish-specific ones.
See the documentation for further information.  <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/712">Bug #712</a> and <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/485">bug #485</a></li>
</ul>
</div>
<div class="section" id="id341">
<h3>varnishtest</h3>
<ul class="simple">
<li>add <tt class="docutils literal"><span class="pre">-l</span></tt> and <tt class="docutils literal"><span class="pre">-L</span></tt> switches which leave <tt class="docutils literal">/tmp/vtc.*</tt> behind on
error and unconditionally respectively.</li>
<li>add <tt class="docutils literal"><span class="pre">-j</span></tt> parameter to run tests in parallell and use this by
default.</li>
</ul>
</div>
<div class="section" id="id342">
<h3>varnishtop</h3>
<ul class="simple">
<li>add <tt class="docutils literal"><span class="pre">-p</span> $period</tt> parameter.  The units in varnishtop were
previously undefined, they are now in requests/period.  The default
period is 60 seconds.</li>
</ul>
</div>
<div class="section" id="id343">
<h3>varnishlog</h3>
<ul class="simple">
<li>group requests by default.  This can be turned off by using <tt class="docutils literal"><span class="pre">-O</span></tt></li>
<li>the <tt class="docutils literal"><span class="pre">-o</span></tt> parameter is now a no-op and is ignored.</li>
</ul>
</div>
</div>
<div class="section" id="id344">
<h2>VMODs</h2>
<ul class="simple">
<li>Add a std VMOD which includes a random function, log, syslog,
fileread, collect,</li>
</ul>
</div>
<div class="section" id="id345">
<h2>VCL</h2>
<ul class="simple">
<li>Change string concatenation to be done using <tt class="docutils literal">+</tt> rather than
implicitly.</li>
<li>Stop using <tt class="docutils literal">%xx</tt> escapes in VCL strings.</li>
<li>Change <tt class="docutils literal">req.hash += value</tt> to <tt class="docutils literal">hash_data(value)</tt></li>
<li>Variables in VCL now have distinct read/write access</li>
<li><tt class="docutils literal">bereq.connect_timeout</tt> is now available in <tt class="docutils literal">vcl_pipe</tt>.</li>
<li>Make it possible to declare probes outside of a director. Please see
the documentation on how to do this.</li>
<li>The VCL compiler has been reworked greatly, expanding its abilities
with regards to what kinds of expressions it understands.</li>
<li>Add <tt class="docutils literal">beresp.backend.name</tt>, <tt class="docutils literal">beresp.backend.ip</tt> and
<tt class="docutils literal">beresp.backend.port</tt> variables.  They are only available from
<tt class="docutils literal">vcl_fetch</tt> and are read only.  <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/481">Bug #481</a></li>
<li>The default VCL now calls pass for any objects where
<tt class="docutils literal">beresp.http.Vary == &quot;*&quot;</tt>.  <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/787">Bug #787</a></li>
<li>The <tt class="docutils literal">log</tt> keyword has been moved to the <tt class="docutils literal">std</tt> VMOD.</li>
<li>It is now possible to choose which storage backend to be used</li>
<li>Add variables <tt class="docutils literal"><span class="pre">storage.$name.free_space</span></tt>,
<tt class="docutils literal"><span class="pre">storage.$name.used_space</span></tt> and <tt class="docutils literal"><span class="pre">storage.$name.happy</span></tt></li>
<li>The variable <tt class="docutils literal">req.can_gzip</tt> tells us whether the client accepts
gzipped objects or not.</li>
<li><tt class="docutils literal">purge</tt> is now called <tt class="docutils literal">ban</tt>, since that is what it really is and
has always been.</li>
<li><tt class="docutils literal">req.esi_level</tt> is now available.  <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/782">Bug #782</a></li>
<li>esi handling is now controlled by the <tt class="docutils literal">beresp.do_esi</tt> boolean rather
than the <tt class="docutils literal">esi</tt> function.</li>
<li><tt class="docutils literal">beresp.do_gzip</tt> and <tt class="docutils literal">beresp.do_gunzip</tt> now control whether an
uncompressed object should be compressed and a compressed object
should be uncompressed in the cache.</li>
<li>make it possible to control compression level using the
<tt class="docutils literal">gzip_level</tt> parameter.</li>
<li><tt class="docutils literal">obj.cacheable</tt> and <tt class="docutils literal">beresp.cacheable</tt> have been removed.
Cacheability is now solely through the <tt class="docutils literal">beresp.ttl</tt> and
<tt class="docutils literal">beresp.grace</tt> variables.</li>
<li>setting the <tt class="docutils literal">obj.ttl</tt> or <tt class="docutils literal">beresp.ttl</tt> to zero now also sets the
corresponding grace to zero.  If you want a non-zero grace, set
grace after setting the TTL.</li>
<li><tt class="docutils literal">return(pass)</tt> in <tt class="docutils literal">vcl_fetch</tt> has been renamed to
<tt class="docutils literal">return(hit_for_pass)</tt> to make it clear that pass in <tt class="docutils literal">vcl_fetch</tt>
and <tt class="docutils literal">vcl_recv</tt> are different beasts.</li>
<li>Add actual purge support.  Doing <tt class="docutils literal">purge</tt> will remove an object and
all its variants.</li>
</ul>
</div>
<div class="section" id="libraries">
<h2>Libraries</h2>
<ul class="simple">
<li><tt class="docutils literal">libvarnishapi</tt> has been overhauled and the API has been broken.
Please see git commit logs and the support tools to understand
what's been changed.</li>
<li>Add functions to walk over all the available counters.  This is
needed because some of the counter names might only be available at
runtime.</li>
<li>Limit the amount of time varnishapi waits for a shared memory log
to appear before returning an error.</li>
<li>All libraries but <tt class="docutils literal">libvarnishapi</tt> have been moved to a private
directory as they are not for public consumption and have no ABI/API
guarantees.</li>
</ul>
</div>
<div class="section" id="id346">
<h2>Other</h2>
<ul class="simple">
<li>Python is now required to build</li>
<li>Varnish Cache is now consistently named Varnish Cache.</li>
<li>The compilation process now looks for kqueue on NetBSD</li>
<li>Make it possible to use a system jemalloc rather than the bundled
version.</li>
<li>The documentation has been improved all over and should now be in
much better shape than before</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-2-1-4-to-2-1-5-2011-01-25">
<h1>Changes from 2.1.4 to 2.1.5 (2011-01-25)</h1>
<div class="section" id="id347">
<h2>varnishd</h2>
<ul class="simple">
<li>On pass from vcl_recv, we did not remove the backends Content-Length
header before adding our own. This could cause confusion for browsers
and has been fixed.</li>
<li>Make pass with content-length work again. An issue with regards to
304, Content-Length and pass has been resolved.</li>
<li>An issue relating to passed requests with If-Modified-Since headers
has been fixed. Varnish did not recognize that the 304-response did
not have a body.</li>
<li>A potential lock-inversion with the ban lurker thread has been
resolved.</li>
<li>Several build-dependency issues relating to rst2man have been fixed.
Varnish should now build from source without rst2man if you are using
tar-balls.</li>
<li>Ensure Varnish reads the expected last CRLF after chunked data from
the backend. This allows re-use of the connection.</li>
<li>Remove a GNU Make-ism during make dist to make BSD happier.</li>
<li>Document the log, set, unset, return and restart statements in the
VCL documentation.</li>
<li>Fix an embarrassingly old bug where Varnish would run out of
workspace when requests come in fast over a single connection,
typically during synthetic benchmarks.</li>
<li>Varnish will now allow If-Modified-Since requests to objects without
a Last-Modified-header, and instead use the time the object was
cached instead.</li>
<li>Do not filter out Content-Range headers in pass.</li>
<li>Require -d, -b, -f, -S or -T when starting varnishd. In human terms,
this means that it is legal to start varnishd without a Vcl or
backend, but only if you have a CLI channel of some kind.</li>
<li>Don't suppress Cache-Control headers in pass responses.</li>
<li>Merge multi-line Cache-Control and Vary header fields. Until now, no
browsers have needed this, but Chromium seems to find it necessary to
spread its Cache-Control across two lines, and we get to deal with
it.</li>
<li>Make new-purge not touch busy objects. This fixes a potential crash
when calling VRT_purge.</li>
<li>If there are everal grace-able objects, pick the least expired one.</li>
<li>Fix an issue with varnishadm -T :6082 shorthand.</li>
<li>Add bourn-shell like &quot;here&quot; documents on the CLI. Typical usage:
vcl.inline vcl_new &lt;&lt; 42 backend foo {...} sub vcl_recv {...} 42</li>
<li>Add CLI version to the CLI-banner, starting with version 1.0 to mark
here-documents.</li>
<li>Fix a problem with the expiry thread slacking off during high load.</li>
</ul>
</div>
<div class="section" id="id348">
<h2>varnishtest</h2>
<ul class="simple">
<li>Remove no longer existing -L option.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-2-1-3-to-2-1-4">
<h1>Changes from 2.1.3 to 2.1.4</h1>
<div class="section" id="id349">
<h2>varnishd</h2>
<ul class="simple">
<li>An embarrasing typo in the new binary heap layout caused inflated
obj/objcore/objhdr counts and could cause odd problems when the LRU
expunge mechanism was invoked. This has been fixed.</li>
<li>We now have updated documentation in the reStructuredText format.
Manual pages and reference documentation are both built from this.</li>
<li>We now include a DNS director which uses DNS for choosing which
backend to route requests to. Please see the documentation for more
details.</li>
<li>If you restarted a request, the HTTP header X-Forwarded-For would be
updated multiple times. This has been fixed.</li>
<li>If a VCL contained a % sign, and the vcl.show CLI command was used,
varnishd would crash. This has been fixed.</li>
<li>When doing a pass operation, we would remove the Content-Length, Age
and Proxy-Auth headers. We are no longer doing this.</li>
<li>now has a string representation, making it easier to construct
Expires headers in VCL.</li>
<li>In a high traffic environment, we would sometimes reuse a file
descriptor before flushing the logs from a worker thread to the
shared log buffer. This would cause confusion in some of the tools.
This has been fixed by explicitly flushing the log when a backend
connection is closed.</li>
<li>If the communication between the management and the child process
gets out of sync, we have no way to recover. Previously, varnishd
would be confused, but we now just kill the child and restart it.</li>
<li>If the backend closes the connection on us just as we sent a request
to it, we retry the request. This should solve some interoperability
problems with Apache and the mpm-itk multi processing module.</li>
<li>varnishd now only provides help output the current CLI session is
authenticated for.</li>
<li>If the backend does not tell us which length indication it is using,
we now assume the resource ends EOF at.</li>
<li>The client director now has a variable client.identity which is used
to choose which backend should receive a given request.</li>
<li>The Solaris port waiter has been updated, and other portability fixes
for Solaris.</li>
<li>There was a corner case in the close-down processing of pipes, this
has now been fixed.</li>
<li>Previously, if we stopped polling a backend which was sick, it never
got marked as healthy. This has now been changed.</li>
<li>It is now possible to specify ports as part of the .host field in
VCL.</li>
<li>The synthetic counters were not locked properly, and so the sms_
counters could underflow. This has now been fixed.</li>
<li>The value of obj.status as a string in vcl_error would not be
correct in all cases. This has been fixed.</li>
<li>Varnish would try to trim storage segments completely filled when
using the malloc stevedore and the object was received chunked
encoding. This has been fixed.</li>
<li>If a buggy backend sends us a Vary header with two colons, we would
previously abort. We now rather fix this up and ignore the extra
colon.</li>
<li>req.hash_always_miss and req.hash_ignore_busy has been added, to
make preloading or periodically refreshing content work better.</li>
</ul>
</div>
<div class="section" id="id350">
<h2>varnishncsa</h2>
<ul class="simple">
<li>varnishncsa would in some cases be confused by ESI requests and
output invalid lines. This has now been fixed.</li>
</ul>
</div>
<div class="section" id="id351">
<h2>varnishlog</h2>
<ul class="simple">
<li>varnishlog now allows -o and -u together.</li>
</ul>
</div>
<div class="section" id="id352">
<h2>varnishtop</h2>
<ul class="simple">
<li>varnishtop would crash on 32 bit architectures. This has been fixed.</li>
</ul>
</div>
<div class="section" id="libvarnishapi">
<h2>libvarnishapi</h2>
<ul class="simple">
<li>Regex inclusion and exclusion had problems with matching particular
parts of the string being matched. This has been fixed.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-2-1-2-to-2-1-3">
<h1>Changes from 2.1.2 to 2.1.3</h1>
<div class="section" id="id353">
<h2>varnishd</h2>
<ul class="simple">
<li>Improve scalability of critbit.</li>
<li>The critbit hash algorithm has now been tightened to make sure the
tree is in a consistent state at all points, and the time we wait for
an object to cool off after it is eligible for garbage collection has
been tweaked.</li>
<li>Add log command to VCL. This emits a VCL_log entry into the shared
memory log.</li>
<li>Only emit Length and ReqEnd log entries if we actually have an XID.
This should get rid of some empty log lines in varnishncsa.</li>
<li>Destroy directors in a predictable fashion, namely reverse of
creation order.</li>
<li>Fix bug when ESI elements spanned storage elements causing a panic.</li>
<li>In some cases, the VCL compiler would panic instead of giving
sensible messages. This has now been fixed.</li>
<li>Correct an off-by-one error when the requested range exceeds the size
of an object.</li>
<li>Handle requests for the end of an object correctly.</li>
<li>Allow tabulator characters in the third field of the first line of
HTTP requests</li>
<li>On Solaris, if the remote end sends us an RST, all system calls
related to that socket will return EINVAL. We now handle this better.</li>
</ul>
</div>
<div class="section" id="id354">
<h2>libvarnishapi</h2>
<ul class="simple">
<li>The -X parameter didn't work correctly. This has been fixed.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-2-1-1-to-2-1-2">
<h1>Changes from 2.1.1 to 2.1.2</h1>
<div class="section" id="id355">
<h2>varnishd</h2>
<ul class="simple">
<li>When adding Range support for 2.1.1, we accidentally introduced a
bug which would append garbage to objects larger than the chunk size,
by default 128k. Browsers would do the right thing due to
Content-Length, but some load balancers would get very confused.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-2-1-1-to-2-1-1">
<h1>Changes from 2.1.1 to 2.1.1</h1>
<div class="section" id="id356">
<h2>varnishd</h2>
<ul class="simple">
<li>The changelog in 2.1.0 included syntax errors, causing the generated
changelog to be empty.</li>
<li>The help text for default_grace was wrongly formatted and included a
syntax error. This has now been fixed.</li>
<li>varnishd now closes the file descriptor used to read the management
secret file (from the -S parameter).</li>
<li>The child would previously try to close every valid file descriptor,
something which could cause problems if the file descriptor ulimit
was set too high. We now keep track of all the file descriptors we
open and only close up to that number.</li>
<li>ESI was partially broken in 2.1.0 due to a bug in the rollback of
session workspace. This has been fixed.</li>
<li>Reject the authcommand rather than crash if there is no -S parameter
given.</li>
<li>Align pointers in allocated objects. This will in theory make Varnish
a tiny bit faster at the expense of slightly more memory usage.</li>
<li>Ensure the master process process id is updated in the shared memory
log file after we go into the background.</li>
<li>HEAD requests would be converted to GET requests too early, which
affected pass and pipe. This has been fixed.</li>
<li>Update the documentation to point out that the TTL is no longer taken
into account to decide whether an object is cacheable or not.</li>
<li>Add support for completely obliterating an object and all variants of
it. Currently, this has to be done using inline C.</li>
<li>Add experimental support for the Range header. This has to be enabled
using the parameter http_range_support.</li>
<li>The critbit hasher could get into a deadlock and had a race
condition. Both those have now been fixed.</li>
</ul>
<p>varnishsizes
-----------~</p>
<ul class="simple">
<li>varnishsizes, which is like varnishhist, but for the length of
objects, has been added..</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-2-0-6-to-2-1-0">
<h1>Changes from 2.0.6 to 2.1.0</h1>
<div class="section" id="id357">
<h2>varnishd</h2>
<ul>
<li><p class="first">Persistent storage is now experimentally supported using the
persistent stevedore. It has the same command line arguments as the
file stevedore.</p>
</li>
<li><p class="first">obj.* is now called beresp.* in vcl_fetch, and obj.* is now
read-only.</p>
</li>
<li><p class="first">The regular expression engine is now PCRE instead of POSIX regular
expressions.</p>
</li>
<li><p class="first">req.* is now available in vcl_deliver.</p>
</li>
<li><p class="first">Add saint mode where we can attempt to grace an object if we don't
like the backend response for some reason.</p>
<p>Related, add saintmode_threshold which is the threshold for the
number of objects to be added to the trouble list before the backend
is considered sick.</p>
</li>
<li><p class="first">Add a new hashing method called critbit. This autoscales and should
work better on large object workloads than the classic hash. Critbit
has been made the default hash algorithm.</p>
</li>
<li><p class="first">When closing connections, we experimented with sending RST to free up
load balancers and free up threads more quickly. This caused some
problems with NAT routers and so has been reverted for now.</p>
</li>
<li><p class="first">Add thread that checks objects against ban list in order to prevent
ban list from growing forever. Note that this needs purges to be
written so they don't depend on req.*. Enabled by setting
ban_lurker_sleep to a nonzero value.</p>
</li>
<li><p class="first">The shared memory log file format was limited to maximum 64k
simultaneous connections. This is now a 32 bit field which removes
this limitation.</p>
</li>
<li><p class="first">Remove obj_workspace, this is now sized automatically.</p>
</li>
<li><p class="first">Rename acceptors to waiters</p>
</li>
<li><p class="first">vcl_prefetch has been removed. It was never fully implemented.</p>
</li>
<li><p class="first">Add support for authenticating CLI connections.</p>
</li>
<li><p class="first">Add hash director that chooses which backend to use depending on
req.hash.</p>
</li>
<li><p class="first">Add client director that chooses which backend to use depending on
the client's IP address. Note that this ignores the X-Forwarded-For
header.</p>
</li>
<li><p class="first">varnishd now displays a banner by default when you connect to the
CLI.</p>
</li>
<li><p class="first">Increase performance somewhat by moving statistics gathering into a
per-worker structure that is regularly flushed to the global stats.</p>
</li>
<li><p class="first">Make sure we store the header and body of object together. This may
in some cases improve performance and is needed for persistence.</p>
</li>
<li><p class="first">Remove client-side address accounting. It was never used for anything
and presented a performance problem.</p>
</li>
<li><p class="first">Add a timestamp to bans, so you can know how old they are.</p>
</li>
<li><p class="first">Quite a few people got confused over the warning about not being able
to lock the shared memory log into RAM, so stop warning about that.</p>
</li>
<li><p class="first">Change the default CLI timeout to 10 seconds.</p>
</li>
<li><p class="first">We previously forced all inserts into the cache to be GET requests.
This has been changed to allow POST as well in order to be able to
implement purge-on-POST semantics.</p>
</li>
<li><p class="first">The CLI command stats now only lists non-zero values.</p>
</li>
<li><p class="first">The CLI command stats now only lists non-zero values.</p>
</li>
<li><p class="first">Use daemon(3) from libcompat on Darwin.</p>
</li>
<li><p class="first">Remove vcl_discard as it causes too much complexity and never
actually worked particularly well.</p>
</li>
<li><p class="first">Remove vcl_timeout as it causes too much complexity and never
actually worked particularly well.</p>
</li>
<li><p class="first">Update the documentation so it refers to sess_workspace, not
http_workspace.</p>
</li>
<li><p class="first">Document the -i switch to varnishd as well as the server.identity and
server.hostname VCL variables.</p>
</li>
<li><p class="first">purge.hash is now deprecated and no longer shown in help listings.</p>
</li>
<li><p class="first">When processing ESI, replace the five mandatory XML entities when we
encounter them.</p>
</li>
<li><p class="first">Add string representations of time and relative time.</p>
</li>
<li><p class="first">Add locking for n_vbe_conn to make it stop underflowing.</p>
</li>
<li><p class="first">When ESI-processing content, check for illegal XML character
entities.</p>
</li>
<li><p class="first">Varnish can now connect its CLI to a remote instance when starting
up, rather than just being connected to.</p>
</li>
<li><p class="first">It is no longer needed to specify the maximum number of HTTP headers
to allow from backends. This is now a run-time parameter.</p>
</li>
<li><p class="first">The X-Forwarded-For header is now generated by vcl_recv rather than
the C code.</p>
</li>
<li><p class="first">It is now possible to not send all CLI traffic to syslog.</p>
</li>
<li><p class="first">It is now possible to not send all CLI traffic to syslog.</p>
</li>
<li><p class="first">In the case of varnish crashing, it now outputs a identifying string
with the OS, OS revision, architecture and storage parameters
together with the backtrace.</p>
</li>
<li><p class="first">Use exponential backoff when we run out of file descriptors or
sessions.</p>
</li>
<li><p class="first">Allow setting backend timeouts to zero.</p>
</li>
<li><p class="first">Count uptime in the shared memory log.</p>
</li>
<li><p class="first">Try to detect the case of two running varnishes with the same shmlog
and storage by writing the master and child process ids to the shmlog
and refusing to start if they are still running.</p>
</li>
<li><p class="first">Make sure to use EOF mode when serving ESI content to HTTP/1.0
clients.</p>
</li>
<li><p class="first">Make sure we close the connection if it either sends Connection:
close or it is a HTTP/1.0 backend that does not send Connection:
keep-alive.</p>
</li>
<li><p class="first">Increase the default session workspace to 64k on 64-bit systems.</p>
</li>
<li><p class="first">Make the epoll waiter use level triggering, not edge triggering as
edge triggering caused problems on very busy servers.</p>
</li>
<li><p class="first">Handle unforeseen client disconnections better on Solaris.</p>
</li>
<li><p class="first">Make session lingering apply to new sessions, not just reused
sessions.</p>
</li>
</ul>
</div>
<div class="section" id="id358">
<h2>varnishstat</h2>
<ul class="simple">
<li>Make use of the new uptime field in the shared memory log rather than
synthesizing it from the start time.</li>
</ul>
</div>
<div class="section" id="id359">
<h2>varnishlog</h2>
<ul class="simple">
<li>Exit at the end of the file when started with -d.</li>
</ul>
</div>
<div class="section" id="id360">
<h2>varnishadm</h2>
<ul class="simple">
<li>varnishadm can now have a timeout when trying to connect to the
running varnishd.</li>
<li>varnishadm now knows how to respond to the secret from a secured
varnishd</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-2-0-5-to-2-0-6">
<h1>Changes from 2.0.5 to 2.0.6</h1>
<div class="section" id="id361">
<h2>varnishd</h2>
<ul class="simple">
<li>2.0.5 had an off-by-one error in the ESI handling causing includes to
fail a large part of the time. This has now been fixed.</li>
<li>Try harder to not confuse backends when sending them backend probes.
We half-closed the connection, something some backends thought meant
we had dropped the connection. Stop doing so, and add the capability
for specifying the expected response code.</li>
<li>In 2.0.5, session lingering was turned on. This caused statistics to
not be counted often enough in some cases. This has now been fixed.</li>
<li>Avoid triggering an assert if the other end closes the connection
while we are lingering and waiting for another request from them.</li>
<li>When generating backtraces, prefer the built-in backtrace function if
such exists. This fixes a problem compiling 2.0.5 on Solaris.</li>
<li>Make it possible to specify the per-thread stack size. This might be
useful on 32 bit systems with their limited address space.</li>
<li>Document the -C option to varnishd.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-2-0-4-to-2-0-5">
<h1>Changes from 2.0.4 to 2.0.5</h1>
<div class="section" id="id362">
<h2>varnishd</h2>
<ul class="simple">
<li>Handle object workspace overruns better.</li>
<li>Allow turning off ESI processing per request by using set req.esi =
off.</li>
<li>Tell the kernel that we expect to use the mmap-ed file in a random
fashion. On Linux, this turns off/down readahead and increases
performance.</li>
<li>Make it possible to change the maximum number of HTTP headers we
allow by passing --with-max-header-fields=NUM rather than changing
the code.</li>
<li>Implement support for HTTP continuation lines.</li>
<li>Change how connections are closed and only use SO_LINGER for orderly
connection closure. This should hopefully make worker threads less
prone to hangups on network problems.</li>
<li>Handle multi-element purges correctly. Previously we ended up with
parse errors when this was done from VCL.</li>
<li>Handle illegal responses from the backend better by serving a 503
page rather than panic-ing.</li>
<li>When we run into an assertion that is not true, Varnish would
previously dump a little bit of information about itself. Extend that
information with a backtrace. Note that this relies on the varnish
binary being unstripped.</li>
<li>Add a session_max parameter that limits the maximum number of
sessions we keep open before we start dropping new connections
summarily.</li>
<li>Try to consume less memory when doing ESI processing by properly
rolling back used workspace after processing an object. This should
make it possible to turn sess_workspace quite a bit for users with
ESI-heavy pages.</li>
<li>Turn on session_linger by default. Tests have shown that
session_linger helps a fair bit with performance.</li>
<li>Rewrite the epoll acceptor for better performance. This should lead
to both higher processing rates and maximum number of connections on
Linux.</li>
<li>Add If-None-Match support, this gives significant bandwidth savings
for users with compliant browsers.</li>
<li>RFC2616 specifies that ETag, Content-Location, Expires, Cache-Control
and Vary should be emitted when delivering a response with the 304
response code.</li>
<li>Various fixes which makes Varnish compile and work on AIX.</li>
<li>Turn on TCP_DEFER_ACCEPT on Linux. This should make us less
suspecible to denial of service attacks as well as give us slightly
better performance.</li>
<li>Add an .initial property to the backend probe specification. This is
the number of good probes we pretend to have seen. The default is one
less than .threshold, which means the first probe will decide if we
consider the backend healthy.</li>
<li>Make it possible to compare strings against other string-like
objects, not just plain strings. This allows you to compare two
headers, for instance.</li>
<li>When support for restart in vcl_error was added, there was no check
to prevent infinte recursion. This has now been fixed.</li>
<li>Turn on purge_dups by default. This should make us consume less
memory when there are many bans for the same pattern added.</li>
<li>Add a new log tag called FetchError which tries to explain why we
could not fetch an object from the backend.</li>
<li>Change the default srcaddr_ttl to 0. It is not used by anything and
has been removed in the development version. This will increase
performance somewhat.</li>
</ul>
</div>
<div class="section" id="id363">
<h2>varnishtop</h2>
<ul class="simple">
<li>varnishtop did not handle variable-length log fields correctly. This
is now fixed.</li>
<li>varnishtop previously did not print the name of the tag, which made
it very hard to understand. We now print out the tag name.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-2-0-3-to-2-0-4">
<h1>Changes from 2.0.3 to 2.0.4</h1>
<div class="section" id="id364">
<h2>varnishd</h2>
<ul class="simple">
<li>Make Varnish more portable by pulling in fixes for Solaris and
NetBSD.</li>
<li>Correct description of -a in the manual page.</li>
<li>Ensure we are compiling in C99 mode.</li>
<li>If error was called with a null reason, we would crash on Solaris.
Make sure this no longer happens.</li>
<li>Varnish used to crash if you asked it to use a non-existent waiter.
This has now been fixed.</li>
<li>Add documentation to the default VCL explaining that using
Connection: close in vcl_pipe is generally a good idea.</li>
<li>Add minimal facility for dealing with TELNET option negotiation by
returning WONT to DO and DONT requests.</li>
<li>If the backend is unhealthy, use a graced object if one is available.</li>
<li>Make server.hostname and server.identity available to VCL. The latter
can be set with the -i parameter to varnishd.</li>
<li>Make restart available from vcl_error.</li>
<li>Previously, only the TTL of an object was considered in whether it
would be marked as cacheable. This has been changed to take the grace
into consideration as well.</li>
<li>Previously, if an included ESI fragment had a zero size, we would
send out a zero-sized chunk which signifies end-of-transmission. We
now ignore zero-sized chunks.</li>
<li>We accidentally slept for far too long when we reached the maximum
number of open file descriptors. This has been corrected and
accept_fd_holdoff now works correctly.</li>
<li>Previously, when ESI processing, we did not look at the full length,
but stopped at the first NULL byte. We no longer do that, enabling
ESI processing of binary data.</li>
</ul>
</div>
<div class="section" id="id365">
<h2>varnishtest</h2>
<ul class="simple">
<li>Make sure system &quot;...&quot; returns successfully to ensure test failures
do not go unnoticed.</li>
<li>Make it possible to send NULL bytes through the testing framework.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-2-0-2-to-2-0-3">
<h1>Changes from 2.0.2 to 2.0.3</h1>
<div class="section" id="id366">
<h2>varnishd</h2>
<ul class="simple">
<li>Handle If-Modified-Since and ESI sub-objects better, fixing a problem
where we sometimes neglected to insert included objects.</li>
<li>restart in vcl_hit is now supported.</li>
<li>Setting the TTL of an object to 0 seconds would sometimes cause it to
be delivered for up to one second - epsilon. This has been corrected
and we should now never deliver those objects to other clients.</li>
<li>The malloc storage backend now prints the maximum storage size, just
like the file backend.</li>
<li>Various small documentation bugs have been fixed.</li>
<li>Varnish did not set a default interval for backend probes, causing it
to poll the backend continuously. This has been corrected.</li>
<li>Allow &quot;true&quot; and &quot;false&quot; when setting boolean parameters, in addition
to on/off, enable/disable and yes/no.</li>
<li>Default to always talking HTTP 1.1 with the backend.</li>
<li>Varnish did not make sure the file it was loading was a regular file.
This could cause Varnish to crash if it was asked to load a directory
or other non-regular file. We now check that the file is a regular
file before loading it.</li>
<li>The binary heap used for expiry processing had scalability problems.
Work around this by using stripes of a fixed size, which should make
this scale better, particularly when starting up and having lots of
objects.</li>
<li>When we imported the jemalloc library into the Varnish tree, it did
not compile without warnings. This has now been fixed.</li>
<li>Varnish took a very long time to detect that the backend did not
respond. To remedy this, we now have read timeouts in addition to the
connect timeout. Both the first_byte_timeout and the
between_bytes_timeout defaults to 60 seconds. The connect timeout
is no longer in milliseconds, but rather in seconds.</li>
<li>Previously, the VCL to C conversion as well as the invocation of the
C compiler was done in the management process. This is now done in a
separate sub-process. This prevents any bugs in the VCL compiler from
affecting the management process.</li>
<li>Chunked encoding headers were counted in the statistics for header
bytes. They no longer are.</li>
<li>ESI processed objects were not counted in the statistics for body
bytes. They now are.</li>
<li>It is now possible to adjust the maximum record length of log entries
in the shmlog by tuning the shm_reclen parameter.</li>
<li>The management parameters listed in the CLI were not sorted, which
made it hard to find the parameter you were looking for. They are now
sorted, which should make this easier.</li>
<li>Add a new hashing type, &quot;critbit&quot;, which uses a lock-less tree based
lookup algorithm. This is experimental and should not be enabled in
production environments without proper testing.</li>
<li>The session workspace had a default size of 8k. It is now 16k, which
should make VCLs where many headers are processed less prone to
panics.</li>
<li>We have seen that people seem to be confused as to which actions in
the different VCL functions return and which ones don't. Add a new
syntax return(action) to make this more explicit. The old syntax is
still supported.</li>
<li>Varnish would return an error if any of the management IPs listed in
the -T parameter could not be listened to. We now only return an
error if none of them can be listened to.</li>
<li>In the case of the backend or client giving us too many parameters,
we used to just ignore the overflowing headers. This is problematic
if you end up ignoreing Content-Length, Transfer-Encoding and similar
headers. We now give out a 400 error to the client if it sends us too
many and 503 if we get too many from the backend.</li>
<li>We used panic if we got a too large chunked header. This behaviour
has been changed into just failing the transaction.</li>
<li>Varnish now supports an extended purge method where it is possible to
do purge req.http.host ~ &quot;web1.com&quot; &amp;&amp; req.url ~ &quot;\.png&quot; and
similar. See the documentation for details.</li>
<li>Under heavy load, Varnish would sometimes crash when trying to update
the per-request statistics. This has now been fixed.</li>
<li>It is now possible to not save the hash string in the session and
object workspace. This will save a lot of memory on sites with many
small objects. Disabling the purge_hash parameter also disables the
purge.hash facility.</li>
<li>Varnish now supports !~ as a &quot;no match&quot; regular expression matcher.</li>
<li>In some cases, you could get serialised access to &quot;pass&quot; objects. We
now make it default to the default_ttl value; this can be overridden
in vcl_fetch.</li>
<li>Varnish did not check the syntax of regsub calls properly. More
checking has been added.</li>
<li>If the client closed the connection while Varnish was processing ESI
elements, Varnish would crash while trying to write the object to the
client. We now check if the client has closed the connection.</li>
<li>The ESI parser had a bug where it would crash if an XML comment would
span storage segments. This has been fixed.</li>
</ul>
<p>VCL Manual page
--------------~</p>
<ul class="simple">
<li>The documentation on how capturing parentheses work was wrong. This
has been corrected.</li>
<li>Grace has now been documented.</li>
</ul>
</div>
<div class="section" id="varnishreplay">
<h2>varnishreplay</h2>
<ul class="simple">
<li>varnishreplay did not work correctly on Linux, due to a too small
stack. This has now been fixed.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-2-0-1-to-2-0-2">
<h1>Changes from 2.0.1 to 2.0.2</h1>
<div class="section" id="id367">
<h2>varnishd</h2>
<ul class="simple">
<li>In high-load situations, when using ESI, varnishd would sometimes
mishandle objects and crash. This has been worked around.</li>
</ul>
</div>
<div class="section" id="id368">
<h2>varnishreplay</h2>
<ul class="simple">
<li>varnishreplay did not work correctly on Linux, due to a too small
stack. This has now been fixed.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-2-0-to-2-0-1">
<h1>Changes from 2.0 to 2.0.1</h1>
<div class="section" id="id369">
<h2>varnishd</h2>
<ul class="simple">
<li>When receiving a garbled HTTP request, varnishd would sometimes
crash. This has been fixed.</li>
<li>There was an off-by-one error in the ACL compilation. Now fixed.</li>
</ul>
<p>Red Hat spec file
----------------~</p>
<ul class="simple">
<li>A typo in the spec file made the .rpm file names wrong.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-1-1-2-to-2-0">
<h1>Changes from 1.1.2 to 2.0</h1>
<div class="section" id="id370">
<h2>varnishd</h2>
<ul class="simple">
<li>Only look for sendfile on platforms where we know how to use it,
which is FreeBSD for now.</li>
<li>Make it possible to adjust the shared memory log size and bump the
size from 8MB to 80MB.</li>
<li>Fix up the handling of request bodies to better match what RFC2616
mandates. This makes PUT, DELETE, OPTIONS and TRACE work in addition
to POST.</li>
<li>Change how backends are defined, to a constant structural defintion
style. See <a class="reference external" href="https://www.varnish-cache.org/wiki/VclSyntaxChanges">https://www.varnish-cache.org/wiki/VclSyntaxChanges</a>
for the details.</li>
<li>Add directors, which wrap backends. Currently, there's a random
director and a round-robin director.</li>
<li>Add &quot;grace&quot;, which is for how long and object will be served, even
after it has expired. To use this, both the object's and the
request's grace parameter need to be set.</li>
<li>Manual pages have been updated for new VCL syntax and varnishd
options.</li>
<li>Man pages and other docs have been updated.</li>
<li>The shared memory log file is now locked in memory, so it should not
be paged out to disk.</li>
<li>We now handle Vary correctly, as well as Expect.</li>
<li>ESI include support is implemented.</li>
<li>Make it possible to limit how much memory the malloc uses.</li>
<li>Solaris is now supported.</li>
<li>There is now a regsuball function, which works like regsub except it
replaces all occurrences of the regex, not just the first.</li>
<li>Backend and director declarations can have a .connect_timeout
parameter, which tells us how long to wait for a successful
connection.</li>
<li>It is now possible to select the acceptor to use by changing the
acceptor parameter.</li>
<li>Backends can have probes associated with them, which can be checked
with req.backend.health in VCL as well as being handled by directors
which do load-balancing.</li>
<li>Support larger-than-2GB files also on 32 bit hosts. Please note that
this does not mean we can support caches bigger than 2GB, it just
means logfiles and similar can be bigger.</li>
<li>In some cases, we would remove the wrong header when we were
stripping Content-Transfer-Encoding headers from a request. This has
been fixed.</li>
<li>Backends can have a .max_connections associated with them.</li>
<li>On Linux, we need to set the dumpable bit on the child if we want
core dumps. Make sure it's set.</li>
<li>Doing purge.hash() with an empty string would cause us to dump core.
Fixed so we don't do that any more.</li>
<li>We ran into a problem with glibc's malloc on Linux where it seemed
like it failed to ever give memory back to the OS, causing the system
to swap. We have now switched to jemalloc which appears not to have
this problem.</li>
<li>max_restarts was never checked, so we always ended up running out of
workspace. Now, vcl_error is called when we reach max_restarts.</li>
</ul>
</div>
<div class="section" id="id371">
<h2>varnishtest</h2>
<ul class="simple">
<li>varnishtest is a tool to do correctness tests of varnishd. The test
suite is run by using make check.</li>
</ul>
</div>
<div class="section" id="id372">
<h2>varnishtop</h2>
<ul class="simple">
<li>We now set the field widths dynamically based on the size of the
terminal and the name of the longest field.</li>
</ul>
</div>
<div class="section" id="id373">
<h2>varnishstat</h2>
<ul class="simple">
<li>varnishstat -1 now displays the uptime too.</li>
</ul>
</div>
<div class="section" id="id374">
<h2>varnishncsa</h2>
<ul class="simple">
<li>varnishncsa now does fflush after each write. This makes tail -f work
correctly, as well as avoiding broken lines in the log file.</li>
<li>It is possible to get varnishncsa to output the X-Forwarded-For
instead of the client IP by passing -f to it.</li>
</ul>
<p>Build system
-----------~</p>
<ul class="simple">
<li>Various sanity checks have been added to configure, it now complains
about no ncurses or if SO_RCVTIMEO or SO_SNDTIMEO are
non-functional. It also aborts if there's no working acceptor
mechanism</li>
<li>The C compiler invocation is decided by the configure script and can
now be overridden by passing VCC_CC when running configure.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-1-1-1-to-1-1-2">
<h1>Changes from 1.1.1 to 1.1.2</h1>
<div class="section" id="id375">
<h2>varnishd</h2>
<ul class="simple">
<li>When switching to a new VCL configuration, a race condition exists
which may cause Varnish to reference a backend which no longer exists
(see <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/144">ticket #144</a>).
This race condition has not been entirely eliminated, but it should
occur less frequently.</li>
<li>When dropping a TCP session before any requests were processed, an
assertion would be triggered due to an uninitialized timestamp (see
<a class="reference external" href="https://www.varnish-cache.org/trac/ticket/132">ticket #132</a>). The
timestamp is now correctly initialized.</li>
<li>Varnish will now correctly generate a Date: header for every response
instead of copying the one it got from the backend (see <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/157">ticket
#157</a>).</li>
<li>Comparisons in VCL which involve a non-existent string (usually a
header which is not present in the request or object being processed)
would cause a NULL pointer dereference; now the comparison will
simply fail.</li>
<li>A bug in the VCL compiler which would cause a double-free when
processing include directives has been fixed.</li>
<li>A resource leak in the worker thread management code has been fixed.</li>
<li>When connecting to a backend, Varnish will usually get the address
from a cache. When the cache is refreshed, existing connections may
end up with a reference to an address structure which no longer
exists, resulting in a crash. This race condition has been somewhat
mitigated, but not entirely eliminated (see <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/144">ticket
#144</a>.)</li>
<li>Varnish will now pass the correct protocol version in pipe mode: the
backend will get what the client sent, and vice versa.</li>
<li>The core of the pipe mode code has been rewritten to increase
robustness and eliminate spurious error messages when either end
closes the connection in a manner Varnish did not anticipate.</li>
<li>A memory leak in the backend code has been plugged.</li>
<li>When using the kqueue acceptor, if a client shuts down the request
side of the connection (as many clients do after sending their final
request), it was possible for the acceptor code to receive the EOF
event and recycle the session while the last request was still being
serviced, resulting in a assertion failure and a crash when the
worker thread later tried to delete the session. This should no
longer happen (see <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/162">ticket
#162</a>.)</li>
<li>A mismatch between the recorded length of a cached object and the
amount of data actually present in cache for that object can
occasionally occur (see <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/167">ticket
#167</a>.) This has been
partially fixed, but may still occur for error pages generated by
Varnish when a problem arises while retrieving an object from the
backend.</li>
<li>Some socket-related system calls may return unexpected error codes
when operating on a TCP connection that has been shut down at the
other end. These error codes would previously cause assertion
failures, but are now recognized as harmless conditions.</li>
</ul>
</div>
<div class="section" id="varnishhist">
<h2>varnishhist</h2>
<ul class="simple">
<li>Pressing 0 though 9 while varnishhist is running will change the
refresh interval to the corresponding power of two, in seconds.</li>
</ul>
</div>
<div class="section" id="id377">
<h2>varnishncsa</h2>
<ul class="simple">
<li>The varnishncsa tool can now daemonize and write a PID file like
varnishlog, using the same command-line options. It will also reopen
its output upon receipt of a SIGHUP if invoked with -w.</li>
</ul>
</div>
<div class="section" id="id378">
<h2>varnishstat</h2>
<ul class="simple">
<li>Pressing 0 though 9 while varnishstat is running will change the
refresh interval to the corresponding power of two, in seconds.</li>
</ul>
<p>Build system
-----------~</p>
<ul class="simple">
<li>Varnish's &lt;queue.h&gt; has been modified to avoid conflicts with
&lt;sys/queue.h&gt; on platforms where the latter is included indirectly
through system headers.</li>
<li>Several steps have been taken towards Solaris support, but this is
not yet complete.</li>
<li>When configure was run without an explicit prefix, Varnish's idea of
the default state directory would be garbage and a state directory
would have to be specified manually with -n. This has been corrected.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-1-1-to-1-1-1">
<h1>Changes from 1.1 to 1.1.1</h1>
<div class="section" id="id379">
<h2>varnishd</h2>
<ul class="simple">
<li>The code required to allow VCL to read obj.status, which had
accidentally been left out, has now been added.</li>
<li>Varnish will now always include a Connection: header in its reply to
the client, to avoid possible misunderstandings.</li>
<li>A bug that triggered an assertion failure when generating synthetic
error documents has been corrected.</li>
<li>A new VCL function, purge_url, provides the same functionality as
the url.purge management command.</li>
<li>Previously, Varnish assumed that the response body should be sent
only if the request method was GET. This was a problem for custom
request methods (such as PURGE), so the logic has been changed to
always send the response body except in the specific case of a HEAD
request.</li>
<li>Changes to run-time parameters are now correctly propagated to the
child process.</li>
<li>Due to the way run-time parameters are initialized at startup,
varnishd previously required the nobody user and the nogroup group to
exist even if a different user and group were specified on the
command line. This has been corrected.</li>
<li>Under certain conditions, the VCL compiler would carry on after a
syntax error instead of exiting after reporting the error. This has
been corrected.</li>
<li>The manner in which the hash string is assembled has been modified to
reduce memory usage and memory-to-memory copying.</li>
<li>Before calling vcl_miss, Varnish assembles a tentative request
object for the backend request which will usually follow. This object
would be leaked if vcl_miss returned anything else than fetch. This
has been corrected.</li>
<li>The code necessary to handle an error return from vcl_fetch and
vcl_deliver had inadvertantly been left out. This has been
corrected.</li>
<li>Varnish no longer prints a spurious &quot;child died&quot; message (the result
of reaping the compiler process) after compiling a new VCL
configuration.</li>
<li>Under some circumstances, due to an error in the workspace management
code, Varnish would lose the &quot;tail&quot; of a request, i.e. the part of
the request that has been received from the client but not yet
processed. The most obvious symptom of this was that POST requests
would work with some browsers but not others, depending on details of
the browser's HTTP implementation. This has been corrected.</li>
<li>On some platforms, due to incorrect assumptions in the CLI code, the
management process would crash while processing commands received
over the management port. This has been corrected.</li>
</ul>
<p>Build system
-----------~</p>
<ul class="simple">
<li>The top-level Makefile will now honor $DESTDIR when creating the
state directory.</li>
<li>The Debian and RedHat packages are now split into three (main / lib /
devel) as is customary.</li>
<li>A number of compile-time and run-time portability issues have been
addressed.</li>
<li>The autogen.sh script had workarounds for problems with the GNU
autotools on FreeBSD; these are no longer needed and have been
removed.</li>
<li>The libcompat library has been renamed to libvarnishcompat and is now
dynamic rather than static. This simplifies the build process and
resolves an issue with the Mac OS X linker.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-1-0-4-to-1-1">
<h1>Changes from 1.0.4 to 1.1</h1>
<div class="section" id="id380">
<h2>varnishd</h2>
<ul class="simple">
<li>Readability of the C source code generated from VCL code has been
improved.</li>
<li>Equality (==) and inequality (!=) operators have been implemented for
IP addresses (which previously could only be compared using ACLs).</li>
<li>The address of the listening socket on which the client connection
was received is now available to VCL as the server.ip variable.</li>
<li>Each object's hash key is now computed based on a string which is
available to VCL as req.hash. A VCL hook named vcl_hash has been
added to allow VCL scripts to control hash generation (for instance,
whether or not to include the value of the Host: header in the hash).</li>
<li>The setup code for listening sockets has been modified to detect and
handle situations where a host name resolves to multiple IP
addresses. It will now attempt to bind to each IP address separately,
and report a failure only if none of them worked.</li>
<li>Network or protocol errors that occur while retrieving an object from
a backend server now result in a synthetic error page being inserted
into the cache with a 30-second TTL. This should help avoid driving
an overburdened backend server into the ground by repeatedly
requesting the same object.</li>
<li>The child process will now drop root privileges immediately upon
startup. The user and group to use are specified with the user and
group run-time parameters, which default to nobody and nogroup,
respectively. Other changes have been made in an effort to increase
the isolation between parent and child, and reduce the impact of a
compromise of the child process.</li>
<li>Objects which are received from the backend with a Vary: header are
now stored separately according to the values of the headers
specified in Vary:. This allows Varnish to correctly cache e.g.
compressed and uncompressed versions of the same object.</li>
<li>Each Varnish instance now has a name, which by default is the host
name of the machine it runs on, but can be any string that would be
valid as a relative or absolute directory name. It is used to
construct the name of a directory in which the server state as well
as all temporary files are stored. This makes it possible to run
multiple Varnish instances on the same machine without conflict.</li>
<li>When invoked with the -C option, varnishd will now not just translate
the VCL code to C, but also compile the C code and attempt to load
the resulting shared object.</li>
<li>Attempts by VCL code to reference a variable outside its scope or to
assign a value to a read-only variable will now result in
compile-time rather than run-time errors.</li>
<li>The new command-line option -F will make varnishd run in the
foreground, without enabling debugging.</li>
<li>New VCL variables have been introduced to allow inspection and
manipulation of the request sent to the backend (bereq.request,
bereq.url, bereq.proto and bereq.http) and the response to the client
(resp.proto, resp.status, resp.response and resp.http).</li>
<li>Statistics from the storage code (including the amount of data and
free space in the cache) are now available to varnishstat and other
statistics-gathering tools.</li>
<li>Objects are now kept on an LRU list which is kept loosely up-to-date
(to within a few seconds). When cache runs out, the objects at the
tail end of the LRU list are discarded one by one until there is
enough space for the freshly requested object(s). A VCL hook,
vcl_discard, is allowed to inspect each object and determine its
fate by returning either keep or discard.</li>
<li>A new VCL hook, vcl_deliver, provides a chance to adjust the
response before it is sent to the client.</li>
<li>A new management command, vcl.show, displays the VCL source code of
any loaded configuration.</li>
<li>A new VCL variable, now, provides VCL scripts with the current time
in seconds since the epoch.</li>
<li>A new VCL variable, obj.lastuse, reflects the time in seconds since
the object in question was last used.</li>
<li>VCL scripts can now add an HTTP header (or modify the value of an
existing one) by assigning a value to the corresponding variable, and
strip an HTTP header by using the remove keyword.</li>
<li>VCL scripts can now modify the HTTP status code of cached objects
(obj.status) and responses (resp.status)</li>
<li>Numeric and other non-textual variables in VCL can now be assigned to
textual variables; they will be converted as needed.</li>
<li>VCL scripts can now apply regular expression substitutions to textual
variables using the regsub function.</li>
<li>A new management command, status, returns the state of the child.</li>
<li>Varnish will now build and run on Mac OS X.</li>
</ul>
</div>
<div class="section" id="id381">
<h2>varnishadm</h2>
<ul class="simple">
<li>This is a new utility which sends a single command to a Varnish
server's management port and prints the result to stdout, greatly
simplifying the use of the management port from scripts.</li>
</ul>
</div>
<div class="section" id="id382">
<h2>varnishhist</h2>
<ul class="simple">
<li>The user interface has been greatly improved; the histogram will be
automatically rescaled and redrawn when the window size changes, and
it is updated regularly rather than at a rate dependent on the amount
of log data gathered. In addition, the name of the Varnish instance
being watched is displayed in the upper right corner.</li>
</ul>
</div>
<div class="section" id="id383">
<h2>varnishncsa</h2>
<ul class="simple">
<li>In addition to client traffic, varnishncsa can now also process log
data from backend traffic.</li>
<li>A bug that would cause varnishncsa to segfault when it encountered an
empty HTTP header in the log file has been fixed.</li>
</ul>
</div>
<div class="section" id="id384">
<h2>varnishreplay</h2>
<ul class="simple">
<li>This new utility will attempt to recreate the HTTP traffic which
resulted in the raw Varnish log data which it is fed.</li>
</ul>
</div>
<div class="section" id="id385">
<h2>varnishstat</h2>
<ul class="simple">
<li>Don't print lifetime averages when it doesn't make any sense, for
instance, there is no point in dividing the amount in bytes of free
cache space by the lifetime in seconds of the varnishd process.</li>
<li>The user interface has been greatly improved; varnishstat will no
longer print more than fits in the terminal, and will respond
correctly to window resize events. The output produced in one-shot
mode has been modified to include symbolic names for each entry. In
addition, the name of the Varnish instance being watched is displayed
in the upper right corner in curses mode.</li>
</ul>
</div>
<div class="section" id="id386">
<h2>varnishtop</h2>
<ul class="simple">
<li>The user interface has been greatly improved; varnishtop will now
respond correctly to window resize events, and one-shot mode (-1)
actually works. In addition, the name of the Varnish instance being
watched is displayed in the upper right corner in curses mode.</li>
</ul>
</div>
</div>
<div class="section" id="changes-from-1-0-3-to-1-0-4">
<h1>Changes from 1.0.3 to 1.0.4</h1>
<div class="section" id="id387">
<h2>varnishd</h2>
<ul>
<li><p class="first">The request workflow has been redesigned to simplify request
processing and eliminate code duplication. All codepaths which need
to speak HTTP now share a single implementation of the protocol. Some
new VCL hooks have been added, though they aren't much use yet. The
only real user-visible change should be that Varnish now handles
persistent backend connections correctly (see <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/56">ticket
#56</a>).</p>
</li>
<li><p class="first">Support for multiple listen addresses has been added.</p>
</li>
<li><p class="first">An &quot;include&quot; facility has been added to VCL, allowing VCL code to
pull in code fragments from multiple files.</p>
</li>
<li><p class="first">Multiple definitions of the same VCL function are now concatenated
into one in the order in which they appear in the source. This
simplifies the mechanism for falling back to the built-in default for
cases which aren't handled in custom code, and facilitates
modularization.</p>
</li>
<li><p class="first">The code used to format management command arguments before passing
them on to the child process would underestimate the amount of space
needed to hold each argument once quotes and special characters were
properly escaped, resulting in a buffer overflow. This has been
corrected.</p>
</li>
<li><p class="first">The VCL compiler has been overhauled. Several memory leaks have been
plugged, and error detection and reporting has been improved
throughout. Parts of the compiler have been refactored to simplify
future extension of the language.</p>
</li>
<li><p class="first">A bug in the VCL compiler which resulted in incorrect parsing of the
decrement (-=) operator has been fixed.</p>
</li>
<li><p class="first">A new -C command-line option has been added which causes varnishd to
compile the VCL code (either from a file specified with -f or the
built-in default), print the resulting C code and exit.</p>
</li>
<li><p class="first">When processing a backend response using chunked encoding, if a chunk
header crosses a read buffer boundary, read additional bytes from the
backend connection until the chunk header is complete.</p>
</li>
<li><p class="first">A new ping_interval run-time parameter controls how often the
management process checks that the worker process is alive.</p>
</li>
<li><p class="first">A bug which would cause the worker process to dereference a NULL
pointer and crash if the backend did not respond has been fixed.</p>
</li>
<li><p class="first">In some cases, such as when they are used by AJAX applications to
circumvent Internet Explorer's over-eager disk cache, it may be
desirable to cache POST requests. However, the code path responsible
for delivering objects from cache would only transmit the response
body when replying to a GET request. This has been extended to also
apply to POST.</p>
<p>This should be revisited at a later date to allow VCL code to control
whether the body is delivered.</p>
</li>
<li><p class="first">Varnish now respects Cache-control: s-maxage, and prefers it to
Cache-control: max-age if both are present.</p>
<p>This should be revisited at a later date to allow VCL code to control
which headers are used and how they are interpreted.</p>
</li>
<li><p class="first">When loading a new VCL script, the management process will now load
the compiled object to verify that it links correctly before
instructing the worker process to load it.</p>
</li>
<li><p class="first">A new -P command-line options has been added which causes varnishd to
create a PID file.</p>
</li>
<li><p class="first">The sendfile_threshold run-time parameter's default value has been
set to infinity after a variety of sendfile()-related bugs were
discovered on several platforms.</p>
</li>
</ul>
</div>
<div class="section" id="id388">
<h2>varnishlog</h2>
<ul class="simple">
<li>When grouping log entries by request, varnishlog attempts to collapse
the log entry for a call to a VCL function with the log entry for the
corresponding return from VCL. When two VCL calls were made in
succession, varnishlog would incorrectly omit the newline between the
two calls (see <a class="reference external" href="https://www.varnish-cache.org/trac/ticket/95">ticket
#95</a>).</li>
<li>New -D and -P command-line options have been added to daemonize and
create a pidfile, respectively.</li>
<li>The flag that is raised upon reception of a SIGHUP has been marked
volatile so it will not be optimized away by the compiler.</li>
</ul>
</div>
<div class="section" id="id389">
<h2>varnishncsa</h2>
<ul>
<li><p class="first">The formatting callback has been largely rewritten for clarity,
robustness and efficiency.</p>
<p>If a request included a Host: header, construct and output an
absolute URL. This makes varnishncsa output from servers which handle
multiple virtual hosts far more useful.</p>
</li>
<li><p class="first">The flag that is raised upon reception of a SIGHUP has been marked
volatile so it will not be optimized away by the compiler.</p>
</li>
</ul>
</div>
<div class="section" id="documentation">
<h2>Documentation</h2>
<ul class="simple">
<li>The documentation, especially the VCL documentation, has been greatly
extended and improved.</li>
</ul>
</div>
<div class="section" id="build-system">
<h2>Build system</h2>
<ul class="simple">
<li>The name and location of the curses or ncurses library is now
correctly detected by the configure script instead of being hardcoded
into affected Makefiles. This allows Varnish to build correctly on a
wider range of platforms.</li>
<li>Compatibility shims for clock_gettime() are now correctly applied
where needed, allowing Varnish to build on MacOS X.</li>
<li>The autogen.sh script will now correctly detect and warn about
automake versions which are known not to work correctly.</li>
</ul>
</div>
</div>
</div>
</body>
</html>
